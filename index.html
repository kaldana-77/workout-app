<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Power Up</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#2c7be5" />
  <link rel="apple-touch-icon" href="wk-icon.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">

  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --line:#e6e9f2;
      --brand:#2c7be5;
      --ok:#12B76A;
      --danger:#e11d48;
      --shadow:0 10px 26px rgba(15,23,42,.08);
      --radius:18px;
      --radius2:14px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background:var(--bg);
      color:var(--text);
    }
    header{
      max-width:860px;
      margin:0 auto;
      padding:20px 14px 10px;
    }
    h1{
      margin:0;
      font-size:34px;
      letter-spacing:.2px;
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .titleEmoji{font-size:.9em}
    .sub{
      margin:6px 0 0;
      color:var(--muted);
      font-weight:650;
    }
    .dateLine{
      margin:6px 0 0;
      color:var(--muted);
      font-weight:650;
    }

    /* Tabs */
    .tabbar{
      margin-top:14px;
      background:#fff;
      border:1px solid var(--line);
      border-radius:999px;
      padding:6px;
      display:flex;
      gap:6px;
      box-shadow:0 6px 16px rgba(15,23,42,.06);
      overflow-x:auto;
      -webkit-overflow-scrolling: touch;
    }
    .tab{
      flex:0 0 auto;
      text-align:center;
      font-weight:850;
      padding:10px 14px;
      border-radius:999px;
      cursor:pointer;
      user-select:none;
      color:var(--muted);
      white-space:nowrap;
    }
    .tab.active{
      background:var(--brand);
      color:#fff;
      box-shadow:0 10px 22px rgba(44,123,229,.25);
    }

    .wrap{max-width:860px; margin:0 auto; padding:12px 14px 90px;}
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
      margin-top:12px;
    }
    .card h2{
      margin:0;
      font-size:22px;
      font-weight:900;
    }
    .hint{
      margin:6px 0 0;
      color:var(--muted);
      font-weight:650;
      line-height:1.35;
    }

    .topRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-top:4px;
      flex-wrap:wrap;
    }
    .rightTools{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .btn{
      border:1px solid var(--line);
      background:#fff;
      border-radius:12px;
      padding:9px 12px;
      font-weight:900;
      cursor:pointer;
      white-space:nowrap;
    }
    .btn.primary{
      background:var(--brand);
      border-color:var(--brand);
      color:#fff;
    }
    .btn.danger{
      background:rgba(225,29,72,.10);
      border-color:rgba(225,29,72,.25);
      color:var(--danger);
    }

    .allDone{
      border:1px solid rgba(18,183,106,.25);
      background:rgba(18,183,106,.10);
      color:var(--ok);
      padding:6px 10px;
      border-radius:999px;
      font-weight:900;
      display:none;
      white-space:nowrap;
    }

    /* Day chips */
    .days{
      display:flex;
      gap:8px;
      margin-top:14px;
      flex-wrap:wrap;
    }
    .chip{
      border:1px solid var(--line);
      background:#fff;
      padding:8px 12px;
      border-radius:999px;
      font-weight:850;
      cursor:pointer;
      color:var(--muted);
      user-select:none;
      min-width:52px;
      text-align:center;
    }
    .chip.active{
      border-color: rgba(44,123,229,.25);
      background: rgba(44,123,229,.10);
      color: var(--brand);
    }

    /* Exercise cards */
    .ex{
      border:1px solid var(--line);
      border-radius:16px;
      padding:14px;
      margin-top:12px;
    }
    .exHead{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
    }
    .exName{
      font-weight:950;
      font-size:18px;
      margin:0;
      line-height:1.15;
    }
    .exMeta{
      margin:4px 0 0;
      color:var(--muted);
      font-weight:700;
    }

    .doneBtn{
      display:flex;
      align-items:center;
      gap:8px;
      border:1px solid var(--line);
      background:#fff;
      border-radius:12px;
      padding:9px 12px;
      font-weight:900;
      cursor:pointer;
      white-space:nowrap;
    }
    .doneBtn.checked{
      border-color: rgba(44,123,229,.25);
      background: rgba(44,123,229,.10);
      color: var(--brand);
    }
    .doneBox{
      width:20px; height:20px;
      border-radius:6px;
      border:2px solid #98A2B3;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-weight:900;
      color:#fff;
      background:#fff;
    }
    .doneBtn.checked .doneBox{
      background: var(--brand);
      border-color: var(--brand);
    }

    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      margin-top:12px;
    }
    @media (max-width:720px){
      .grid2{grid-template-columns:1fr;}
    }
    label{
      display:block;
      font-size:12px;
      font-weight:850;
      color:var(--muted);
      margin-bottom:6px;
    }
    input, textarea, select{
      width:100%;
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px 12px;
      font-size:14px;
      font-weight:650;
      outline:none;
      background:#fff;
    }
    textarea{min-height:48px; resize:vertical;}

    .resetLink{
      margin-top:14px;
      color:var(--danger);
      font-weight:850;
      cursor:pointer;
      text-decoration:underline;
      display:inline-block;
    }

    .footerNote{
      text-align:center;
      color:var(--muted);
      font-weight:650;
      margin-top:14px;
    }

    /* Progress tiles */
    .statGrid{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
      margin-top:12px;
    }
    @media (max-width:720px){
      .statGrid{grid-template-columns:1fr;}
    }
    .stat{
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px;
      background:#fff;
    }
    .stat .k{color:var(--muted); font-weight:850; font-size:12px;}
    .stat .v{font-weight:950; font-size:20px; margin-top:4px;}

    /* Check list rows */
    .check{
      display:flex;
      align-items:flex-start;
      gap:10px;
      padding:10px 12px;
      border:1px solid var(--line);
      border-radius:14px;
      background:#fff;
      margin-top:10px;
    }
    .check input{
      width:18px; height:18px; margin-top:2px;
      accent-color: var(--brand);
    }
    .check .t{font-weight:900;}
    .check .s{margin-top:4px; color:var(--muted); font-weight:650; font-size:13px; line-height:1.35;}

    /* Measurements */
    .measGrid{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
      margin-top:12px;
    }
    @media (max-width:720px){
      .measGrid{grid-template-columns:1fr;}
    }

    /* Modal */
    .modalBack{
      position:fixed; inset:0;
      background:rgba(0,0,0,.35);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:50;
    }
    .modal{
      width:min(860px, 100%);
      background:#fff;
      border:1px solid var(--line);
      border-radius:18px;
      box-shadow:0 30px 80px rgba(0,0,0,.22);
      padding:14px;
      max-height:85vh;
      overflow:auto;
    }
    .modalTop{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .modal h3{margin:0; font-size:18px; font-weight:950;}
    .modal p{margin:6px 0 0; color:var(--muted); font-weight:650;}
    .rowBtns{
      display:flex;
      gap:10px;
      margin-top:12px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .editRow{
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
      margin-top:10px;
      background:#fff;
    }
    .editGrid{
      display:grid;
      grid-template-columns: 1.4fr 1fr 1fr;
      gap:10px;
      margin-top:10px;
    }
    @media (max-width:720px){
      .editGrid{grid-template-columns:1fr;}
    }
    .small{
      font-size:12px;
      color:var(--muted);
      font-weight:650;
      margin-top:6px;
      line-height:1.35;
    }
    .linkBtn{
      border:none;
      background:none;
      color:var(--brand);
      font-weight:900;
      cursor:pointer;
      padding:0;
      text-decoration:underline;
      text-align:left;
    }

    /* Monday pulse */
    @keyframes pulseSoft{
      0%{transform:scale(1);opacity:1}
      50%{transform:scale(1.03);opacity:.9}
      100%{transform:scale(1);opacity:1}
    }
    .mondayPulse{ animation:pulseSoft 2.5s ease-in-out infinite; }

  </style>
</head>

<body>
  <header>
    <h1 id="appTitle">Power Up <span class="titleEmoji">üèãÔ∏è‚Äç‚ôÄÔ∏èüíß</span></h1>
    <div class="sub">Steady Progress.</div>
    <div class="dateLine" id="dateLine"></div>

    <div class="tabbar" role="tablist">
      <div class="tab active" data-tab="workout">Workout</div>
      <div class="tab" data-tab="progress">Progress</div>
      <div class="tab" data-tab="week">Week Summary</div>
      <div class="tab" data-tab="reset">Health Reset</div>
      <div class="tab" data-tab="measurements">Measurements</div>
    </div>
  </header>

  <main class="wrap">
    <!-- WORKOUT -->
    <section id="tab-workout">
      <div class="card">
        <div class="topRow">
          <div>
            <h2 id="dayTitle">Monday workout</h2>
            <div class="hint">Tap a day, check off exercises, and jot quick notes.</div>
          </div>
          <div class="rightTools">
            <button class="btn" id="editPlanBtn" type="button">Edit plan</button>
            <div class="allDone" id="allDonePill">All done ‚úì</div>
          </div>
        </div>

        <div class="days" id="dayChips"></div>
        <div id="exerciseList"></div>

        <div class="resetLink" id="resetTodayLink">Reset this day‚Äôs progress (today only).</div>
      </div>

      <div class="footerNote">All data is stored locally in your browser on this device only.</div>
    </section>

    <!-- PROGRESS -->
    <section id="tab-progress" style="display:none;">
      <div class="card">
        <h2>Progress</h2>
        <div class="hint">Today‚Äôs completion + week-to-date.</div>

        <div class="statGrid">
          <div class="stat">
            <div class="k">Today</div>
            <div class="v" id="statToday">0%</div>
          </div>
          <div class="stat">
            <div class="k">Completed exercises (today)</div>
            <div class="v" id="statTodayCount">0 / 0</div>
          </div>
          <div class="stat">
            <div class="k">Days completed this week</div>
            <div class="v" id="statWeekDays">0</div>
          </div>
        </div>
      </div>

      <div class="footerNote">Built by consistency.</div>
    </section>

    <!-- WEEK SUMMARY -->
    <section id="tab-week" style="display:none;">
      <div class="card">
        <h2>Week Summary</h2>
        <div class="hint">A quick overview of each day.</div>
        <div id="weekSummary"></div>
      </div>
      <div class="footerNote">Built by consistency.</div>
    </section>

    <!-- HEALTH RESET -->
    <section id="tab-reset" style="display:none;">
      <div class="card">
        <div class="topRow">
          <div>
            <h2>Health Reset</h2>
            <div class="hint">Daily checklist (resets each day). You can edit it.</div>
          </div>
          <div class="rightTools">
            <button class="btn" id="editResetBtn" type="button">Edit reset</button>
          </div>
        </div>

        <div style="margin-top:10px;">
          <h3 style="margin:0; font-size:16px; font-weight:950;">Morning Thyroid Routine</h3>
          <div id="resetMorning"></div>
        </div>

        <div style="margin-top:14px;">
          <h3 style="margin:0; font-size:16px; font-weight:950;">Supplements Schedule</h3>
          <div id="resetSupps"></div>
        </div>

        <div style="margin-top:14px;">
          <h3 style="margin:0; font-size:16px; font-weight:950;">2-Week Thyroid-Friendly Reset</h3>
          <div id="resetRules"></div>
        </div>
      </div>

      <div class="footerNote">These checkmarks reset daily by date.</div>
    </section>

    <!-- MEASUREMENTS -->
    <section id="tab-measurements" style="display:none;">
      <div class="card">
        <h2>Measurements (Weekly)</h2>
        <div class="hint">Track trends, not perfection.</div>

        <div class="measGrid">
          <div>
            <label>Weight</label>
            <input id="m_weight" type="text" placeholder="e.g., 160" />
          </div>
          <div>
            <label>Waist</label>
            <input id="m_waist" type="text" placeholder="inches" />
          </div>
          <div>
            <label>Hips</label>
            <input id="m_hips" type="text" placeholder="inches" />
          </div>
          <div>
            <label>Chest</label>
            <input id="m_chest" type="text" placeholder="inches" />
          </div>
          <div>
            <label>Thigh</label>
            <input id="m_thigh" type="text" placeholder="inches" />
          </div>
          <div>
            <label>Arm</label>
            <input id="m_arm" type="text" placeholder="inches" />
          </div>
        </div>

        <div class="rowBtns" style="margin-top:12px;">
          <button class="btn primary" id="measSaveBtn" type="button">Save this week</button>
          <button class="btn danger" id="measClearBtn" type="button">Clear this week</button>
        </div>

        <div id="measHistory" style="margin-top:14px;"></div>
      </div>

      <div class="footerNote">Built by consistency.</div>
    </section>
  </main>

  <!-- EDIT PLAN MODAL -->
  <div class="modalBack" id="modalBack" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalTop">
        <div>
          <h3 id="modalTitle">Edit plan</h3>
          <p id="modalSub">Pick from the library or type your own. Saved changes show immediately.</p>
        </div>
        <div class="rowBtns" style="justify-content:flex-start;">
          <button class="btn" id="addExerciseBtn" type="button">+ Add exercise</button>
          <button class="btn danger" id="restoreDefaultsBtn" type="button">Restore defaults</button>
          <button class="btn" id="closeModalBtn" type="button">Close</button>
        </div>
      </div>

      <div class="small">
        Tip: Use ‚ÄúCategory‚Äù ‚Üí ‚ÄúExercise‚Äù to fill name/sets/reps fast. You can still edit the text.
      </div>

      <div id="editorBody" style="margin-top:10px;"></div>

      <div class="rowBtns">
        <button class="btn" id="cancelEditBtn" type="button">Cancel</button>
        <button class="btn primary" id="saveEditBtn" type="button">Save changes</button>
      </div>
    </div>
  </div>

  <!-- RESET EDITOR MODAL -->
  <div class="modalBack" id="resetBack" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalTop">
        <div>
          <h3>Edit Health Reset</h3>
          <p>Change wording, add/remove items. Saved changes show immediately.</p>
        </div>
        <div class="rowBtns" style="justify-content:flex-start;">
          <button class="btn" id="resetCloseBtn" type="button">Close</button>
        </div>
      </div>

      <div id="resetEditorBody" style="margin-top:10px;"></div>

      <div class="rowBtns">
        <button class="btn danger" id="resetRestoreBtn" type="button">Restore defaults</button>
        <button class="btn primary" id="resetSaveBtn" type="button">Save reset</button>
      </div>
    </div>
  </div>

  <!-- INFO POPUP (circuits/mobility) -->
  <div class="modalBack" id="infoBack" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalTop">
        <div>
          <h3 id="infoTitle">Details</h3>
          <p id="infoSub">Quick guide</p>
        </div>
        <div class="rowBtns" style="justify-content:flex-start;">
          <button class="btn" id="infoCloseBtn" type="button">Close</button>
        </div>
      </div>
      <div id="infoBody" style="margin-top:10px; line-height:1.45;"></div>
    </div>
  </div>

<script>
/***********************
 * Data + Defaults
 ***********************/
const DAYS = ["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"];

/* Your original weekly plan (with the circuit/mobility items present) */
const DEFAULT_PLAN = {
  Monday: [
    { name: "Incline Dumbbell Press", sets: 3, reps: "10‚Äì12" },
    { name: "Lat Pulldown", sets: 3, reps: "10‚Äì12" },
    { name: "Dumbbell Shoulder Press", sets: 3, reps: "10‚Äì12" },
    { name: "Triceps Rope Pushdown", sets: 3, reps: "12‚Äì15" },
    { name: "Walking Treadmill", sets: 1, reps: "20‚Äì30 min" }
  ],
  Tuesday: [
    { name: "Goblet Squat", sets: 3, reps: "10‚Äì12" },
    { name: "Romanian Deadlift", sets: 3, reps: "10‚Äì12" },
    { name: "Glute Bridge/Hip Thrust", sets: 3, reps: "12‚Äì15" },
    { name: "Calf Raises", sets: 3, reps: "15‚Äì20" },
    { name: "Walking Treadmill", sets: 1, reps: "20‚Äì30 min" }
  ],
  Wednesday: [
    { name: "Push-Ups / Incline Push-Ups", sets: 3, reps: "As many as possible" },
    { name: "Dumbbell Row", sets: 3, reps: "10‚Äì12" },
    { name: "Lateral Raises", sets: 3, reps: "12‚Äì15" },
    { name: "Biceps Curls", sets: 3, reps: "10‚Äì12" },
    { name: "Core Circuit", sets: 3, reps: "3‚Äì4 exercises" }
  ],
  Thursday: [
    { name: "Leg Press or Step-Ups", sets: 3, reps: "10‚Äì12" },
    { name: "Lunges (or split squats)", sets: 3, reps: "10‚Äì12/leg" },
    { name: "Hamstring Curl", sets: 3, reps: "10‚Äì12" },
    { name: "Core Circuit", sets: 3, reps: "3‚Äì4 exercises" },
    { name: "Walking Treadmill", sets: 1, reps: "20‚Äì30 min" }
  ],
  Friday: [
    { name: "Full-Body Circuit", sets: 3, reps: "8‚Äì10 exercises" },
    { name: "Extra Arms / Glutes", sets: 2, reps: "Choose your favs" },
    { name: "Stretching / Mobility", sets: 1, reps: "10‚Äì15 min" },
    { name: "Walking Treadmill", sets: 1, reps: "20‚Äì30 min" }
  ],
  Saturday: [
    { name: "Optional: Light Walk", sets: 1, reps: "20‚Äì40 min" },
    { name: "Stretching / Yoga", sets: 1, reps: "10‚Äì20 min" }
  ],
  Sunday: [
    { name: "Rest / Mobility", sets: 1, reps: "10‚Äì20 min" }
  ]
};

/* Circuit + Mobility popups (your exact text) */
const POPUPS = {
  "Core Circuit": `
  <div style="font-weight:950; margin-bottom:8px;">Pick 3‚Äì4 moves below. Do them in a loop.</div>
  <ul>
    <li>Rest 30‚Äì45 seconds between moves.</li>
    <li>Rest 60‚Äì90 seconds between rounds.</li>
    <li><b>Total time:</b> 10‚Äì15 minutes</li>
  </ul>
  <div style="margin-top:12px; font-weight:950;">Option A (best overall)</div>
  <ul>
    <li>Dead Bug ‚Äì 8‚Äì10/side</li>
    <li>Bird Dog ‚Äì 8‚Äì10/side</li>
    <li>Side Plank ‚Äì 20‚Äì30 sec/side</li>
    <li>Glute Bridge ‚Äì 12‚Äì15</li>
  </ul>
  <div style="margin-top:12px; font-weight:950;">Option B (more ‚Äútight waist‚Äù feel)</div>
  <ul>
    <li>Pallof Press (band/cable) ‚Äì 10‚Äì12/side</li>
    <li>Plank ‚Äì 30‚Äì45 sec</li>
    <li>Suitcase Carry (one dumbbell) ‚Äì 30‚Äì45 sec/side</li>
    <li>Reverse Crunch ‚Äì 10‚Äì12 (slow)</li>
  </ul>
  <div style="margin-top:10px; font-weight:900;">üëâ Rule: if anything hurts your low back, swap it.</div>
  `,
  "Full-Body Circuit": `
  <div style="font-weight:950; margin-bottom:8px;">‚úÖ Full-Body Circuit (3 sets ‚Ä¢ 8‚Äì10 exercises)</div>
  <div>This is a moderate pace circuit, not HIIT.</div>
  <ul>
    <li>Pick 8 exercises (or use my ready-made one below).</li>
    <li>Work 35‚Äì45 sec, rest 15‚Äì25 sec between exercises.</li>
    <li>Rest 90 sec between rounds.</li>
    <li><b>Total time:</b> 20‚Äì30 minutes</li>
  </ul>
  <div style="margin-top:12px; font-weight:950;">Ready-made Full-Body Circuit (my favorite for fat loss + strength)</div>
  <ul>
    <li>Goblet Squat</li>
    <li>Dumbbell Row</li>
    <li>Incline Dumbbell Press (or push-ups)</li>
    <li>Romanian Deadlift (light‚Äìmoderate)</li>
    <li>Shoulder Press</li>
    <li>Lateral Raise</li>
    <li>Glute Bridge / Hip Thrust</li>
    <li>Pallof Press or Dead Bug</li>
  </ul>
  <div style="margin-top:10px; font-weight:900;">Optional 9‚Äì10:</div>
  <ul>
    <li>Biceps Curl</li>
    <li>Triceps Rope Pushdown</li>
  </ul>
  <div style="margin-top:10px;"><b>üëâ Keep weights</b> where you can maintain good form. The goal is ‚Äúsweaty but controlled.‚Äù</div>
  `,
  "Stretching / Mobility": `
  <div style="font-weight:950; margin-bottom:8px;">‚úÖ Stretching / Mobility (10‚Äì15 min)</div>
  <div>This is your ‚Äúfeel better tomorrow‚Äù block.</div>
  <div style="margin-top:10px; font-weight:950;">Quick 10‚Äì12 minute mobility flow</div>
  <ul>
    <li>Chest opener stretch (doorway) ‚Äì 45 sec</li>
    <li>Child‚Äôs pose ‚Äì 45 sec</li>
    <li>Hip flexor stretch ‚Äì 45 sec/side</li>
    <li>Figure-4 glute stretch ‚Äì 45 sec/side</li>
    <li>Hamstring stretch ‚Äì 45 sec/side</li>
    <li>Thoracic rotation (‚Äúopen books‚Äù) ‚Äì 8 reps/side</li>
    <li>Calf stretch ‚Äì 30‚Äì45 sec/side</li>
  </ul>
  <div style="margin-top:10px;"><b>If knees are cranky:</b> do hip + upper body stretches more, less deep knee bending.</div>
  `
};

/* Exercise Library (for picker in Edit Plan) */
const EX_LIBRARY = {
  "Chest": [
    {name:"Incline Dumbbell Press", sets:3, reps:"10‚Äì12"},
    {name:"Dumbbell Bench Press", sets:3, reps:"8‚Äì12"},
    {name:"Push-Ups", sets:3, reps:"AMRAP"},
    {name:"Incline Push-Ups", sets:3, reps:"AMRAP"}
  ],
  "Back": [
    {name:"Lat Pulldown", sets:3, reps:"10‚Äì12"},
    {name:"Dumbbell Row", sets:3, reps:"10‚Äì12"},
    {name:"Seated Cable Row", sets:3, reps:"10‚Äì12"},
    {name:"Face Pulls", sets:3, reps:"12‚Äì15"}
  ],
  "Shoulders": [
    {name:"Dumbbell Shoulder Press", sets:3, reps:"10‚Äì12"},
    {name:"Lateral Raises", sets:3, reps:"12‚Äì15"},
    {name:"Rear Delt Fly", sets:3, reps:"12‚Äì15"}
  ],
  "Biceps": [
    {name:"Biceps Curls", sets:3, reps:"10‚Äì12"},
    {name:"Hammer Curls", sets:3, reps:"12‚Äì15"}
  ],
  "Triceps": [
    {name:"Triceps Rope Pushdown", sets:3, reps:"12‚Äì15"},
    {name:"Overhead Triceps Extension", sets:3, reps:"10‚Äì12"},
    {name:"Bench Dips", sets:3, reps:"12‚Äì15"}
  ],
  "Legs/Glutes": [
    {name:"Goblet Squat", sets:3, reps:"10‚Äì12"},
    {name:"Romanian Deadlift", sets:3, reps:"10‚Äì12"},
    {name:"Leg Press or Step-Ups", sets:3, reps:"10‚Äì12"},
    {name:"Lunges (or split squats)", sets:3, reps:"10‚Äì12/leg"},
    {name:"Hamstring Curl", sets:3, reps:"10‚Äì12"},
    {name:"Glute Bridge/Hip Thrust", sets:3, reps:"12‚Äì15"},
    {name:"Calf Raises", sets:3, reps:"15‚Äì20"}
  ],
  "Core": [
    {name:"Dead Bug", sets:3, reps:"8‚Äì10/side"},
    {name:"Bird Dog", sets:3, reps:"8‚Äì10/side"},
    {name:"Pallof Press", sets:3, reps:"10‚Äì12/side"},
    {name:"Plank", sets:3, reps:"30‚Äì45 sec"}
  ],
  "Cardio": [
    {name:"Walking Treadmill", sets:1, reps:"20‚Äì30 min"},
    {name:"Optional: Light Walk", sets:1, reps:"20‚Äì40 min"}
  ],
  "Mobility": [
    {name:"Stretching / Mobility", sets:1, reps:"10‚Äì15 min"},
    {name:"Stretching / Yoga", sets:1, reps:"10‚Äì20 min"},
    {name:"Rest / Mobility", sets:1, reps:"10‚Äì20 min"}
  ],
  "Circuits": [
    {name:"Core Circuit", sets:3, reps:"3‚Äì4 exercises"},
    {name:"Full-Body Circuit", sets:3, reps:"8‚Äì10 exercises"},
    {name:"Extra Arms / Glutes", sets:2, reps:"Choose your favs"}
  ]
};

/* Health Reset defaults (editable) */
const RESET_DEFAULT = {
  morning: [
    { key:"synthroid", title:"6:30 AM: Synthroid (empty stomach)", sub:"Water is fine. Avoid supplements/minerals/fiber for 45‚Äì60 minutes." },
    { key:"lemon", title:"Warm lemon water at work is OK", sub:"No minerals in lemon = fine with Synthroid timing." },
    { key:"coffee", title:"Coffee + collagen after your wait window", sub:"Aim for 45‚Äì60 minutes after Synthroid." },
    { key:"salt", title:"Finish Baja Gold salt water after coffee", sub:"Small sips earlier are fine; finishing later is the cleanest." }
  ],
  supps: [
    { key:"lunch_probiotic", title:"Lunch: Good Girl Probiotic", sub:"Keep consistent." },
    { key:"lunch_omega", title:"Lunch: Omega-3", sub:"With food." },
    { key:"dinner_multi", title:"Dinner: MultiComplete", sub:"Keeps minerals away from Synthroid." },
    { key:"dinner_chromium", title:"Dinner: Chromium picolinate (if using)", sub:"Best with your higher-carb meal." },
    { key:"dinner_citrucel", title:"Dinner: Citrucel", sub:"Helps keep fiber away from Synthroid window." },
    { key:"bed_mag", title:"Bedtime: Magnesium", sub:"Supports sleep + insulin sensitivity." },
    { key:"asneeded_hum", title:"As needed: HUM Flatter Me", sub:"With the FIRST bite of heavy/carb meals." }
  ],
  rules: [
    { key:"protein", title:"Protein first at every meal", sub:"Stabilizes appetite and blood sugar." },
    { key:"carb_once", title:"Carbs once per day", sub:"Pick the meal you want them most." },
    { key:"portion", title:"Heavy-carb meals: cut portion in half", sub:"Eat protein first, then carbs. Stop at satisfied." },
    { key:"walk", title:"Walk 10‚Äì15 minutes after carb meals", sub:"Big impact on glucose control." },
    { key:"no_hiit", title:"No punishment HIIT", sub:"Keep stress lower for easier fat loss." }
  ]
};

/***********************
 * Storage
 ***********************/
const LS = {
  workoutProgress: "pu_progress_v2",   // { dayName: { exIndex: {done, weight, notes} } }
  planOverride: "pu_planOverride_v2",  // plan object
  resetChecks: "pu_resetChecks_v2",    // { "YYYY-MM-DD": { key: true } }
  resetOverride: "pu_resetOverride_v2",// {morning:[], supps:[], rules:[]}
  measurements: "pu_measurements_v2"   // { weekKey: {fields...} }
};

function load(key, fallback){
  try{
    const v = JSON.parse(localStorage.getItem(key));
    return (v === null || v === undefined) ? fallback : v;
  }catch{ return fallback; }
}
function save(key, val){ localStorage.setItem(key, JSON.stringify(val)); }

/***********************
 * Date helpers
 ***********************/
function pad(n){ return String(n).padStart(2,"0"); }
function isoDate(d){ return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; }
function prettyDate(d){
  return d.toLocaleDateString(undefined, { weekday:"long", month:"short", day:"numeric", year:"numeric" });
}
function currentDayName(){
  return new Date().toLocaleDateString(undefined, { weekday:"long" });
}
/* Week key = Monday of current week */
function weekKey(d){
  const x = new Date(d);
  const day = x.getDay(); // 0 Sun, 1 Mon...
  const diff = (day === 0 ? -6 : (1 - day)); // move to Monday
  x.setDate(x.getDate() + diff);
  return isoDate(x);
}

/***********************
 * Plan
 ***********************/
function getPlan(){
  const override = load(LS.planOverride, null);
  return (override && typeof override === "object") ? override : DEFAULT_PLAN;
}
function setPlan(plan){ save(LS.planOverride, plan); }

/***********************
 * App State
 ***********************/
const today = new Date();
const todayISO = isoDate(today);
let selectedDay = DAYS.includes(currentDayName()) ? currentDayName() : "Monday";

/***********************
 * Tabs
 ***********************/
const tabEls = Array.from(document.querySelectorAll(".tab"));
const sections = {
  workout: document.getElementById("tab-workout"),
  progress: document.getElementById("tab-progress"),
  week: document.getElementById("tab-week"),
  reset: document.getElementById("tab-reset"),
  measurements: document.getElementById("tab-measurements")
};
tabEls.forEach(t => t.addEventListener("click", () => setTab(t.dataset.tab)));

function setTab(name){
  tabEls.forEach(t => t.classList.toggle("active", t.dataset.tab === name));
  Object.keys(sections).forEach(k => sections[k].style.display = (k === name) ? "" : "none";
  if(name === "workout") renderWorkout();
  if(name === "progress") renderProgress();
  if(name === "week") renderWeekSummary();
  if(name === "reset") renderReset();
  if(name === "measurements") renderMeasurements();
}

/***********************
 * Workout Progress
 ***********************/
function getProgress(){ return load(LS.workoutProgress, {}); }
function setExerciseField(day, idx, field, value){
  const p = getProgress();
  p[day] = p[day] || {};
  p[day][idx] = p[day][idx] || { done:false, weight:"", notes:"" };
  p[day][idx][field] = value;
  save(LS.workoutProgress, p);
}
function getExerciseState(day, idx){
  const p = getProgress();
  return (p[day] && p[day][idx]) ? p[day][idx] : { done:false, weight:"", notes:"" };
}
function resetDayProgress(day){
  const p = getProgress();
  delete p[day];
  save(LS.workoutProgress, p);
}

function dayCompletion(day){
  const plan = getPlan();
  const exercises = plan[day] || [];
  if(exercises.length === 0) return { done:0, total:0, pct:0 };
  let done = 0;
  exercises.forEach((_, idx) => { if(getExerciseState(day, idx).done) done++; });
  return { done, total: exercises.length, pct: Math.round((done / exercises.length) * 100) };
}

/***********************
 * Render Workout
 ***********************/
const dayTitle = document.getElementById("dayTitle");
const allDonePill = document.getElementById("allDonePill");
const dayChips = document.getElementById("dayChips");
const exerciseList = document.getElementById("exerciseList");
const resetTodayLink = document.getElementById("resetTodayLink");

function renderDayChips(){
  dayChips.innerHTML = "";
  DAYS.forEach(d => {
    const c = document.createElement("div");
    c.className = "chip" + (d === selectedDay ? " active" : "");
    c.textContent = d.slice(0,3);
    c.title = d;
    c.addEventListener("click", () => { selectedDay = d; renderWorkout(); });
    dayChips.appendChild(c);
  });
}

function renderWorkout(){
  renderDayChips();
  dayTitle.textContent = `${selectedDay} workout`;

  const plan = getPlan();
  const exercises = plan[selectedDay] || [];
  exerciseList.innerHTML = "";

  let doneCount = 0;

  exercises.forEach((ex, idx) => {
    const st = getExerciseState(selectedDay, idx);
    if(st.done) doneCount++;

    const isPopup = !!POPUPS[ex.name];

    const wrap = document.createElement("div");
    wrap.className = "ex";
    wrap.innerHTML = `
      <div class="exHead">
        <div>
          <p class="exName">
            ${escapeHtml(ex.name)}
          </p>
          <div class="exMeta">${escapeHtml(String(ex.sets))} sets ‚Ä¢ ${escapeHtml(ex.reps)}</div>
          ${isPopup ? `<button class="linkBtn" type="button" style="margin-top:8px;">View details</button>` : ``}
        </div>

        <button class="doneBtn ${st.done ? "checked" : ""}" type="button">
          <span class="doneBox">${st.done ? "‚úì" : ""}</span>
          Done
        </button>
      </div>

      <div class="grid2">
        <div>
          <label>Weight / Level</label>
          <input type="text" placeholder="e.g. 15 lb DBs" value="${escapeAttr(st.weight || "")}" />
        </div>
        <div>
          <label>Notes</label>
          <textarea placeholder="How it felt, tweaks, etc.">${escapeHtml(st.notes || "")}</textarea>
        </div>
      </div>
    `;

    const doneBtn = wrap.querySelector(".doneBtn");
    const weightInput = wrap.querySelector("input");
    const notesArea = wrap.querySelector("textarea");

    doneBtn.addEventListener("click", () => {
      const cur = getExerciseState(selectedDay, idx);
      setExerciseField(selectedDay, idx, "done", !cur.done);
      renderWorkout();
      renderProgress();
      renderWeekSummary();
    });

    weightInput.addEventListener("input", (e) => setExerciseField(selectedDay, idx, "weight", e.target.value));
    notesArea.addEventListener("input", (e) => setExerciseField(selectedDay, idx, "notes", e.target.value));

    const detailsBtn = wrap.querySelector(".linkBtn");
    if(detailsBtn){
      detailsBtn.addEventListener("click", () => openInfo(ex.name));
    }

    exerciseList.appendChild(wrap);
  });

  const allDone = exercises.length > 0 && doneCount === exercises.length;
  allDonePill.style.display = allDone ? "inline-block" : "none";
}

resetTodayLink.addEventListener("click", () => {
  const todayName = currentDayName();
  if(selectedDay !== todayName){
    alert("This reset link is for today's day only. Tap today's day to reset it.");
    return;
  }
  if(confirm("Reset today's progress? This will clear Done/Weight/Notes for today.")){
    resetDayProgress(selectedDay);
    renderWorkout();
    renderProgress();
    renderWeekSummary();
  }
});

/***********************
 * Progress + Week Summary
 ***********************/
const statToday = document.getElementById("statToday");
const statTodayCount = document.getElementById("statTodayCount");
const statWeekDays = document.getElementById("statWeekDays");
const weekSummary = document.getElementById("weekSummary");

function renderProgress(){
  const todayName = currentDayName();
  const c = dayCompletion(todayName);
  statToday.textContent = `${c.pct}%`;
  statTodayCount.textContent = `${c.done} / ${c.total}`;

  let completedDays = 0;
  DAYS.forEach(d => {
    const dc = dayCompletion(d);
    if(dc.total > 0 && dc.done === dc.total) completedDays++;
  });
  statWeekDays.textContent = String(completedDays);
}

function renderWeekSummary(){
  weekSummary.innerHTML = "";
  DAYS.forEach(d => {
    const c = dayCompletion(d);
    const row = document.createElement("div");
    row.className = "ex";
    row.style.padding = "12px 14px";
    row.innerHTML = `
      <div class="exHead">
        <div>
          <p class="exName" style="font-size:16px; margin:0;">${d}</p>
          <div class="exMeta">${c.done} / ${c.total} completed ‚Ä¢ ${c.pct}%</div>
        </div>
        <div class="allDone" style="display:${(c.total>0 && c.done===c.total) ? "inline-block" : "none"};">All done ‚úì</div>
      </div>
    `;
    weekSummary.appendChild(row);
  });
}

/***********************
 * Health Reset (editable + daily checks)
 ***********************/
const resetMorningEl = document.getElementById("resetMorning");
const resetSuppsEl = document.getElementById("resetSupps");
const resetRulesEl = document.getElementById("resetRules");

function getResetData(){
  const override = load(LS.resetOverride, null);
  if(override && override.morning && override.supps && override.rules) return override;
  return RESET_DEFAULT;
}
function setResetData(data){ save(LS.resetOverride, data); }

function getResetChecks(){ return load(LS.resetChecks, {}); }
function getChecksForToday(){
  const all = getResetChecks();
  return all[todayISO] || {};
}
function setCheck(key, val){
  const all = getResetChecks();
  const day = all[todayISO] || {};
  day[key] = !!val;
  all[todayISO] = day;
  save(LS.resetChecks, all);
}
function renderResetSection(container, items){
  container.innerHTML = "";
  const checks = getChecksForToday();

  items.forEach(it => {
    const row = document.createElement("div");
    row.className = "check";
    row.innerHTML = `
      <input type="checkbox" ${checks[it.key] ? "checked" : ""} />
      <div>
        <div class="t">${escapeHtml(it.title)}</div>
        <div class="s">${escapeHtml(it.sub)}</div>
      </div>
    `;
    row.querySelector("input").addEventListener("change", (e) => setCheck(it.key, e.target.checked));
    container.appendChild(row);
  });
}
function renderReset(){
  const data = getResetData();
  renderResetSection(resetMorningEl, data.morning);
  renderResetSection(resetSuppsEl, data.supps);
  renderResetSection(resetRulesEl, data.rules);
}

/***********************
 * Measurements (weekly)
 ***********************/
const mFields = ["weight","waist","hips","chest","thigh","arm"];
const measHistory = document.getElementById("measHistory");
const measSaveBtn = document.getElementById("measSaveBtn");
const measClearBtn = document.getElementById("measClearBtn");

function getMeasurements(){ return load(LS.measurements, {}); }
function setMeasurements(v){ save(LS.measurements, v); }

function renderMeasurements(){
  const wk = weekKey(new Date());
  const all = getMeasurements();
  const cur = all[wk] || {};

  mFields.forEach(f => {
    const el = document.getElementById("m_"+f);
    el.value = cur[f] || "";
  });

  // history
  measHistory.innerHTML = "";
  const keys = Object.keys(all).sort().reverse();
  if(keys.length === 0){
    measHistory.innerHTML = `<div class="hint" style="margin-top:10px;">No entries yet.</div>`;
    return;
  }

  keys.forEach(k => {
    const row = document.createElement("div");
    row.className = "ex";
    row.style.padding="12px 14px";
    const v = all[k] || {};
    row.innerHTML = `
      <div style="font-weight:950;">Week of ${escapeHtml(k)}</div>
      <div class="small">
        Weight: <b>${escapeHtml(v.weight||"‚Äî")}</b> ‚Ä¢ Waist: <b>${escapeHtml(v.waist||"‚Äî")}</b> ‚Ä¢ Hips: <b>${escapeHtml(v.hips||"‚Äî")}</b>
        <br/>Chest: <b>${escapeHtml(v.chest||"‚Äî")}</b> ‚Ä¢ Thigh: <b>${escapeHtml(v.thigh||"‚Äî")}</b> ‚Ä¢ Arm: <b>${escapeHtml(v.arm||"‚Äî")}</b>
      </div>
    `;
    measHistory.appendChild(row);
  });
}

measSaveBtn.addEventListener("click", () => {
  const wk = weekKey(new Date());
  const all = getMeasurements();
  all[wk] = all[wk] || {};
  mFields.forEach(f => { all[wk][f] = (document.getElementById("m_"+f).value || "").trim(); });
  setMeasurements(all);
  alert("Saved!");
  renderMeasurements();
});

measClearBtn.addEventListener("click", () => {
  const wk = weekKey(new Date());
  if(!confirm("Clear this week's fields?")) return;
  mFields.forEach(f => { document.getElementById("m_"+f).value = ""; });
  const all = getMeasurements();
  if(all[wk]){ delete all[wk]; setMeasurements(all); }
  renderMeasurements();
});

/***********************
 * Info popup
 ***********************/
const infoBack = document.getElementById("infoBack");
const infoTitle = document.getElementById("infoTitle");
const infoSub = document.getElementById("infoSub");
const infoBody = document.getElementById("infoBody");
document.getElementById("infoCloseBtn").addEventListener("click", closeInfo);
infoBack.addEventListener("click", (e)=>{ if(e.target===infoBack) closeInfo(); });

function openInfo(name){
  infoTitle.textContent = name;
  infoSub.textContent = "Quick guide";
  infoBody.innerHTML = POPUPS[name] || `<div class="hint">No details yet.</div>`;
  infoBack.style.display = "flex";
}
function closeInfo(){ infoBack.style.display = "none"; }

/***********************
 * Edit Plan Modal (with library picker)
 ***********************/
const editPlanBtn = document.getElementById("editPlanBtn");
const modalBack = document.getElementById("modalBack");
const editorBody = document.getElementById("editorBody");
const closeModalBtn = document.getElementById("closeModalBtn");
const cancelEditBtn = document.getElementById("cancelEditBtn");
const saveEditBtn = document.getElementById("saveEditBtn");
const addExerciseBtn = document.getElementById("addExerciseBtn");
const restoreDefaultsBtn = document.getElementById("restoreDefaultsBtn");

let draftPlan = null;

function openEditor(){
  draftPlan = structuredClone(getPlan());
  renderEditorRows();
  modalBack.style.display = "flex";
}
function closeEditor(){
  modalBack.style.display = "none";
  draftPlan = null;
}
modalBack.addEventListener("click", (e)=>{ if(e.target===modalBack) closeEditor(); });

editPlanBtn.addEventListener("click", openEditor);
closeModalBtn.addEventListener("click", closeEditor);
cancelEditBtn.addEventListener("click", closeEditor);

function categoryOptions(){
  const cats = Object.keys(EX_LIBRARY);
  return cats.map(c => `<option value="${escapeAttr(c)}">${escapeHtml(c)}</option>`).join("");
}
function exerciseOptions(cat){
  const list = EX_LIBRARY[cat] || [];
  return [`<option value="">‚Äî choose ‚Äî</option>`]
    .concat(list.map((x, i)=> `<option value="${i}">${escapeHtml(x.name)}</option>`))
    .join("");
}

function renderEditorRows(){
  editorBody.innerHTML = "";
  const list = (draftPlan && draftPlan[selectedDay]) ? draftPlan[selectedDay] : [];

  if(list.length === 0){
    const empty = document.createElement("div");
    empty.className = "editRow";
    empty.innerHTML = `<div style="font-weight:950;">No exercises yet.</div><div class="small">Click ‚ÄúAdd exercise‚Äù to create one.</div>`;
    editorBody.appendChild(empty);
    return;
  }

  list.forEach((ex, idx) => {
    const row = document.createElement("div");
    row.className = "editRow";

    // default category guess
    const cats = Object.keys(EX_LIBRARY);
    let guess = cats.find(c => (EX_LIBRARY[c]||[]).some(x => x.name === ex.name)) || "Chest";

    row.innerHTML = `
      <div style="display:flex; justify-content:space-between; gap:10px; align-items:center; flex-wrap:wrap;">
        <div style="font-weight:950;">Exercise ${idx+1}</div>
        <button class="btn danger" type="button">Delete</button>
      </div>

      <div class="editGrid">
        <div>
          <label>Category</label>
          <select class="catSel">${categoryOptions()}</select>
        </div>
        <div>
          <label>Pick from library</label>
          <select class="pickSel"></select>
        </div>
        <div>
          <label>Sets</label>
          <input class="setsIn" type="number" min="1" step="1" value="${escapeAttr(ex.sets ?? 3)}" />
        </div>
      </div>

      <div class="editGrid" style="grid-template-columns: 2fr 1fr 1fr; margin-top:10px;">
        <div>
          <label>Name (you can type)</label>
          <input class="nameIn" type="text" value="${escapeAttr(ex.name || "")}" />
        </div>
        <div>
          <label>Reps</label>
          <input class="repsIn" type="text" value="${escapeAttr(ex.reps || "")}" />
        </div>
        <div style="display:flex; align-items:flex-end;">
          <button class="btn" type="button" style="width:100%;">View details</button>
        </div>
      </div>
      <div class="small">‚ÄúView details‚Äù works for Core Circuit / Full-Body Circuit / Stretching.</div>
    `;

    const delBtn = row.querySelector(".btn.danger");
    const catSel = row.querySelector(".catSel");
    const pickSel = row.querySelector(".pickSel");
    const nameIn = row.querySelector(".nameIn");
    const setsIn = row.querySelector(".setsIn");
    const repsIn = row.querySelector(".repsIn");
    const detailsBtn = row.querySelectorAll(".btn")[1];

    catSel.value = guess;
    pickSel.innerHTML = exerciseOptions(catSel.value);

    catSel.addEventListener("change", () => {
      pickSel.innerHTML = exerciseOptions(catSel.value);
      pickSel.value = "";
    });

    pickSel.addEventListener("change", () => {
      const i = parseInt(pickSel.value, 10);
      const list = EX_LIBRARY[catSel.value] || [];
      const chosen = Number.isFinite(i) ? list[i] : null;
      if(!chosen) return;
      draftPlan[selectedDay][idx].name = chosen.name;
      draftPlan[selectedDay][idx].sets = chosen.sets;
      draftPlan[selectedDay][idx].reps = chosen.reps;

      nameIn.value = chosen.name;
      setsIn.value = chosen.sets;
      repsIn.value = chosen.reps;
    });

    nameIn.addEventListener("input", (e) => { draftPlan[selectedDay][idx].name = e.target.value; });
    setsIn.addEventListener("input", (e) => {
      const v = parseInt(e.target.value, 10);
      draftPlan[selectedDay][idx].sets = Number.isFinite(v) && v > 0 ? v : 1;
    });
    repsIn.addEventListener("input", (e) => { draftPlan[selectedDay][idx].reps = e.target.value; });

    detailsBtn.addEventListener("click", () => {
      const nm = (draftPlan[selectedDay][idx].name || "").trim();
      if(POPUPS[nm]) openInfo(nm);
      else alert("Details are only set up for Core Circuit, Full-Body Circuit, and Stretching / Mobility right now.");
    });

    delBtn.addEventListener("click", () => {
      if(!confirm("Delete this exercise?")) return;
      draftPlan[selectedDay].splice(idx, 1);
      renderEditorRows();
    });

    editorBody.appendChild(row);
  });
}

addExerciseBtn.addEventListener("click", () => {
  if(!draftPlan[selectedDay]) draftPlan[selectedDay] = [];
  draftPlan[selectedDay].push({ name:"New Exercise", sets:3, reps:"10‚Äì12" });
  renderEditorRows();
});

restoreDefaultsBtn.addEventListener("click", () => {
  if(!confirm("Restore your original default plan for ALL days? (This does not erase your workout notes.)")) return;
  setPlan(structuredClone(DEFAULT_PLAN));
  closeEditor();
  renderWorkout();
  renderProgress();
  renderWeekSummary();
  alert("Defaults restored.");
});

saveEditBtn.addEventListener("click", () => {
  const list = draftPlan[selectedDay] || [];
  for(const ex of list){
    ex.name = String(ex.name || "").trim() || "Unnamed Exercise";
    ex.reps = String(ex.reps || "").trim() || "‚Äî";
    const s = parseInt(ex.sets, 10);
    ex.sets = Number.isFinite(s) && s > 0 ? s : 1;
  }
  setPlan(draftPlan);
  closeEditor();
  renderWorkout();
  renderProgress();
  renderWeekSummary();
  alert("Plan saved!");
});

/***********************
 * Reset Editor
 ***********************/
const editResetBtn = document.getElementById("editResetBtn");
const resetBack = document.getElementById("resetBack");
const resetEditorBody = document.getElementById("resetEditorBody");
const resetCloseBtn = document.getElementById("resetCloseBtn");
const resetSaveBtn = document.getElementById("resetSaveBtn");
const resetRestoreBtn = document.getElementById("resetRestoreBtn");

let resetDraft = null;

function openResetEditor(){
  resetDraft = structuredClone(getResetData());
  renderResetEditor();
  resetBack.style.display = "flex";
}
function closeResetEditor(){
  resetBack.style.display = "none";
  resetDraft = null;
}
resetBack.addEventListener("click", (e)=>{ if(e.target===resetBack) closeResetEditor(); });

editResetBtn.addEventListener("click", openResetEditor);
resetCloseBtn.addEventListener("click", closeResetEditor);

function renderResetEditor(){
  resetEditorBody.innerHTML = "";

  const sections = [
    {key:"morning", title:"Morning Thyroid Routine"},
    {key:"supps", title:"Supplements Schedule"},
    {key:"rules", title:"2-Week Reset Rules"}
  ];

  sections.forEach(sec => {
    const box = document.createElement("div");
    box.className = "editRow";
    box.innerHTML = `
      <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
        <div style="font-weight:950;">${escapeHtml(sec.title)}</div>
        <button class="btn" type="button">+ Add</button>
      </div>
      <div class="small">Edit text freely. ‚ÄúKey‚Äù is used for daily checkmarks.</div>
      <div class="secBody" style="margin-top:8px;"></div>
    `;

    const addBtn = box.querySelector(".btn");
    const secBody = box.querySelector(".secBody");

    function renderItems(){
      secBody.innerHTML = "";
      const items = resetDraft[sec.key] || [];
      items.forEach((it, i) => {
        const row = document.createElement("div");
        row.className = "editRow";
        row.style.marginTop = "10px";
        row.innerHTML = `
          <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
            <div style="font-weight:900;">Item ${i+1}</div>
            <button class="btn danger" type="button">Delete</button>
          </div>
          <div class="editGrid">
            <div>
              <label>Key</label>
              <input type="text" value="${escapeAttr(it.key || "")}">
            </div>
            <div style="grid-column: span 2;">
              <label>Title</label>
              <input type="text" value="${escapeAttr(it.title || "")}">
            </div>
          </div>
          <div style="margin-top:10px;">
            <label>Subtext</label>
            <input type="text" value="${escapeAttr(it.sub || "")}">
          </div>
        `;

        const del = row.querySelector(".btn.danger");
        const inputs = row.querySelectorAll("input");
        const [keyIn, titleIn, subIn] = inputs;

        keyIn.addEventListener("input", e => resetDraft[sec.key][i].key = e.target.value);
        titleIn.addEventListener("input", e => resetDraft[sec.key][i].title = e.target.value);
        subIn.addEventListener("input", e => resetDraft[sec.key][i].sub = e.target.value);

        del.addEventListener("click", () => {
          if(!confirm("Delete this item?")) return;
          resetDraft[sec.key].splice(i,1);
          renderItems();
        });

        secBody.appendChild(row);
      });
    }

    addBtn.addEventListener("click", () => {
      resetDraft[sec.key] = resetDraft[sec.key] || [];
      resetDraft[sec.key].push({ key:`new_${Date.now()}`, title:"New item", sub:"" });
      renderItems();
    });

    renderItems();
    resetEditorBody.appendChild(box);
  });
}

resetRestoreBtn.addEventListener("click", () => {
  if(!confirm("Restore Health Reset defaults?")) return;
  setResetData(structuredClone(RESET_DEFAULT));
  closeResetEditor();
  renderReset();
  alert("Reset defaults restored.");
});

resetSaveBtn.addEventListener("click", () => {
  // sanitize
  ["morning","supps","rules"].forEach(k => {
    resetDraft[k] = (resetDraft[k] || []).map(it => ({
      key: String(it.key || "").trim() || `key_${Math.random().toString(16).slice(2)}`,
      title: String(it.title || "").trim() || "Untitled",
      sub: String(it.sub || "").trim() || ""
    }));
  });
  setResetData(resetDraft);
  closeResetEditor();
  renderReset();
  alert("Health Reset saved!");
});

/***********************
 * Boot
 ***********************/
document.getElementById("dateLine").textContent = prettyDate(today);

// Monday pulse on title (Monday = 1)
if(new Date().getDay() === 1){
  document.getElementById("appTitle").classList.add("mondayPulse");
}

renderWorkout();
renderProgress();
renderWeekSummary();
renderReset();
renderMeasurements();
setTab("workout");

/***********************
 * Escapes
 ***********************/
function escapeHtml(str){
  return String(str)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function escapeAttr(str){
  return escapeHtml(str).replaceAll("\n"," ");
}
</script>
</body>
</html>
