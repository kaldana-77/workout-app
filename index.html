<script src="workouts.js"></script>
<script>
/*************************
 * Storage keys
 *************************/
const LS = {
  workoutProgress: "pu_progress_v1",
  resetChecks: "pu_resetChecks_v1",
  planOverride: "pu_planOverride_v1",
  measurements: "pu_measurements_v1"
};

/*************************
 * Helpers
 *************************/
const DAYS = ["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"];

function pad(n){ return String(n).padStart(2,"0"); }
function isoDate(d){ return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; }
function prettyDate(d){
  return d.toLocaleDateString(undefined, { weekday:"long", month:"short", day:"numeric", year:"numeric" });
}
function currentDayName(){
  return new Date().toLocaleDateString(undefined, { weekday:"long" });
}

function load(key, fallback){
  try{
    const v = JSON.parse(localStorage.getItem(key));
    return (v === null || v === undefined) ? fallback : v;
  }catch{
    return fallback;
  }
}
function save(key, val){
  localStorage.setItem(key, JSON.stringify(val));
}

function escapeHtml(str){
  return String(str)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function escapeAttr(str){
  return escapeHtml(str).replaceAll("\n"," ");
}

/*************************
 * Data sources
 *************************/

// Your workouts.js provides window.workoutPlan (your plan with descriptions)
const DEFAULT_PLAN = (window.workoutPlan && typeof window.workoutPlan === "object")
  ? window.workoutPlan
  : {
      Monday: [
        { name:"Incline Dumbbell Press", sets:3, reps:"10‚Äì12", description:"" },
        { name:"Lat Pulldown", sets:3, reps:"10‚Äì12", description:"" }
      ],
      Tuesday: [
        { name:"Goblet Squat", sets:3, reps:"10‚Äì12", description:"" }
      ]
    };

// Health Reset content (this is your supplement guide + reset rules)
const RESET_MORNING = [
  { key:"synthroid", title:"6:30 AM: Synthroid (empty stomach)", sub:"Water is fine. Avoid supplements/minerals/fiber for 45‚Äì60 minutes." },
  { key:"lemon", title:"Warm lemon water at work is OK", sub:"Lemon itself is fine with Synthroid timing." },
  { key:"coffee", title:"Coffee + collagen after your wait window", sub:"Aim for 45‚Äì60 minutes after Synthroid." },
  { key:"salt", title:"Finish Baja Gold salt water after coffee", sub:"Small sips earlier are usually OK; finishing later is the cleanest." }
];

const RESET_SUPPS = [
  { key:"hum", title:"HUM Flatter Me", sub:"With the FIRST bite of heavier/carb meals." },
  { key:"probiotic", title:"Lunch: Good Girl Probiotic", sub:"Keep consistent." },
  { key:"omega", title:"Lunch: Omega-3", sub:"With food." },
  { key:"berberine", title:"Lunch: Berberine (if keeping it)", sub:"With food. If bloating returns, pause and reassess." },
  { key:"multi", title:"Dinner: MultiComplete", sub:"Keeps minerals away from Synthroid." },
  { key:"citrucel", title:"Dinner: Citrucel", sub:"Keeps fiber away from Synthroid." },
  { key:"mag", title:"Bedtime: Magnesium", sub:"Supports sleep + recovery." }
];

const RESET_RULES = [
  { key:"protein", title:"Protein first at every meal", sub:"Stabilizes appetite and blood sugar." },
  { key:"portion", title:"Heavy-carb meals: cut portion in half", sub:"Protein first, then carbs. Stop at satisfied." },
  { key:"walk", title:"Walk 10‚Äì15 minutes after carb meals", sub:"One of the best belly-fat support habits." },
  { key:"no_hiit", title:"No punishment HIIT", sub:"Steady workouts > cortisol spikes." }
];

/*************************
 * Plan source / overrides
 *************************/
function getPlan(){
  const override = load(LS.planOverride, null);
  if(override && typeof override === "object") return override;
  return structuredClone(DEFAULT_PLAN);
}
function setPlan(plan){
  save(LS.planOverride, plan);
}

/*************************
 * App state
 *************************/
const today = new Date();
const todayISO = isoDate(today);
let selectedDay = DAYS.includes(currentDayName()) ? currentDayName() : "Monday";

/*************************
 * Tabs
 *************************/
const tabEls = Array.from(document.querySelectorAll(".tab"));
const sections = {
  workout: document.getElementById("tab-workout"),
  progress: document.getElementById("tab-progress"),
  week: document.getElementById("tab-week"),
  reset: document.getElementById("tab-reset"),
  measurements: document.getElementById("tab-measurements")
};

tabEls.forEach(t => t.addEventListener("click", () => setTab(t.dataset.tab)));

function setTab(name){
  tabEls.forEach(t => t.classList.toggle("active", t.dataset.tab === name));
  Object.keys(sections).forEach(k => sections[k].style.display = (k === name) ? "" : "none");
  if(name === "workout") renderWorkout();
  if(name === "progress") renderProgress();
  if(name === "week") renderWeekSummary();
  if(name === "reset") renderReset();
  if(name === "measurements") renderMeasurements();
}

/*************************
 * Workout progress
 *************************/
const dayTitle = document.getElementById("dayTitle");
const allDonePill = document.getElementById("allDonePill");
const dayChips = document.getElementById("dayChips");
const exerciseList = document.getElementById("exerciseList");
const resetTodayLink = document.getElementById("resetTodayLink");

function getProgress(){ return load(LS.workoutProgress, {}); }

function setExerciseField(day, idx, field, value){
  const p = getProgress();
  p[day] = p[day] || {};
  p[day][idx] = p[day][idx] || { done:false, weight:"", notes:"" };
  p[day][idx][field] = value;
  save(LS.workoutProgress, p);
}
function getExerciseState(day, idx){
  const p = getProgress();
  return (p[day] && p[day][idx]) ? p[day][idx] : { done:false, weight:"", notes:"" };
}
function resetDayProgress(day){
  const p = getProgress();
  delete p[day];
  save(LS.workoutProgress, p);
}

function renderDayChips(){
  dayChips.innerHTML = "";
  DAYS.forEach(d => {
    const c = document.createElement("div");
    c.className = "chip" + (d === selectedDay ? " active" : "");
    c.textContent = d.slice(0,3);
    c.title = d;
    c.addEventListener("click", () => { selectedDay = d; renderWorkout(); });
    dayChips.appendChild(c);
  });
}

function renderWorkout(){
  renderDayChips();
  dayTitle.textContent = `${selectedDay} workout`;

  const plan = getPlan();
  const exercises = plan[selectedDay] || [];
  exerciseList.innerHTML = "";

  let doneCount = 0;

  exercises.forEach((ex, idx) => {
    const st = getExerciseState(selectedDay, idx);
    if(st.done) doneCount++;

    const wrap = document.createElement("div");
    wrap.className = "ex";
    wrap.innerHTML = `
      <div class="exHead">
        <div>
          <p class="exName exercise-name" title="${escapeAttr(ex.description || "")}">
            ${escapeHtml(ex.name)}
          </p>
          <div class="exMeta">${ex.sets} sets ‚Ä¢ ${escapeHtml(ex.reps)}</div>
        </div>
        <button class="doneBtn ${st.done ? "checked" : ""}" type="button">
          <span class="doneBox">${st.done ? "‚úì" : ""}</span>
          Done
        </button>
      </div>

      <div class="grid2">
        <div>
          <label>Weight / Level</label>
          <input type="text" placeholder="e.g. 15 lb DBs" value="${escapeAttr(st.weight || "")}" />
        </div>
        <div>
          <label>Notes</label>
          <textarea placeholder="How it felt, tweaks, etc.">${escapeHtml(st.notes || "")}</textarea>
        </div>
      </div>
    `;

    const doneBtn = wrap.querySelector(".doneBtn");
    const weightInput = wrap.querySelector("input");
    const notesArea = wrap.querySelector("textarea");

    doneBtn.addEventListener("click", () => {
      const cur = getExerciseState(selectedDay, idx);
      setExerciseField(selectedDay, idx, "done", !cur.done);
      renderWorkout();
      renderProgress();
      renderWeekSummary();
    });

    weightInput.addEventListener("input", (e) => setExerciseField(selectedDay, idx, "weight", e.target.value));
    notesArea.addEventListener("input", (e) => setExerciseField(selectedDay, idx, "notes", e.target.value));

    // Popup for circuit/mobility (optional): click name to open details for certain items
    wrap.querySelector(".exName").addEventListener("click", () => {
      const n = (ex.name || "").toLowerCase();
      if(n.includes("core circuit")) openInfo("Core Circuit", CORE_CIRCUIT_HTML);
      if(n.includes("full-body circuit") || n.includes("full body circuit")) openInfo("Full-Body Circuit", FULL_BODY_HTML);
      if(n.includes("stretching") || n.includes("mobility")) openInfo("Stretching / Mobility", MOBILITY_HTML);
    });

    exerciseList.appendChild(wrap);
  });

  const allDone = exercises.length > 0 && doneCount === exercises.length;
  allDonePill.style.display = allDone ? "inline-block" : "none";
}

// reset today link
resetTodayLink.addEventListener("click", () => {
  const todayName = currentDayName();
  if(selectedDay !== todayName){
    alert("This reset link is for today only. Tap today‚Äôs day to reset it.");
    return;
  }
  if(confirm("Reset today‚Äôs progress? This clears Done/Weight/Notes for today.")){
    resetDayProgress(selectedDay);
    renderWorkout();
    renderProgress();
    renderWeekSummary();
  }
});

/*************************
 * Progress + Week summary
 *************************/
const statToday = document.getElementById("statToday");
const statTodayCount = document.getElementById("statTodayCount");
const statWeekDays = document.getElementById("statWeekDays");
const weekSummary = document.getElementById("weekSummary");

function dayCompletion(day){
  const plan = getPlan();
  const exercises = plan[day] || [];
  if(exercises.length === 0) return { done:0, total:0, pct:0 };
  let done = 0;
  exercises.forEach((_, idx) => { if(getExerciseState(day, idx).done) done++; });
  const pct = Math.round((done / exercises.length) * 100);
  return { done, total: exercises.length, pct };
}

function renderProgress(){
  const c = dayCompletion(currentDayName());
  statToday.textContent = `${c.pct}%`;
  statTodayCount.textContent = `${c.done} / ${c.total}`;

  let completedDays = 0;
  DAYS.forEach(d => {
    const dc = dayCompletion(d);
    if(dc.total > 0 && dc.done === dc.total) completedDays++;
  });
  statWeekDays.textContent = String(completedDays);
}

function renderWeekSummary(){
  weekSummary.innerHTML = "";
  DAYS.forEach(d => {
    const c = dayCompletion(d);
    const row = document.createElement("div");
    row.className = "ex";
    row.style.padding = "12px 14px";
    row.innerHTML = `
      <div class="exHead">
        <div>
          <p class="exName" style="font-size:16px; margin:0;">${d}</p>
          <div class="exMeta">${c.done} / ${c.total} completed ‚Ä¢ ${c.pct}%</div>
        </div>
        <div class="allDone" style="display:${(c.total>0 && c.done===c.total) ? "inline-block" : "none"};">All done ‚úì</div>
      </div>
    `;
    weekSummary.appendChild(row);
  });
}

/*************************
 * Health Reset (daily by date)
 *************************/
const resetMorningEl = document.getElementById("resetMorning");
const resetSuppsEl = document.getElementById("resetSupps");
const resetRulesEl = document.getElementById("resetRules");

function getResetChecks(){ return load(LS.resetChecks, {}); }
function getChecksForToday(){
  const all = getResetChecks();
  return all[todayISO] || {};
}
function setCheck(key, val){
  const all = getResetChecks();
  const day = all[todayISO] || {};
  day[key] = !!val;
  all[todayISO] = day;
  save(LS.resetChecks, all);
}

function renderResetSection(container, items){
  container.innerHTML = "";
  const checks = getChecksForToday();

  items.forEach(it => {
    const row = document.createElement("div");
    row.className = "check";
    row.innerHTML = `
      <input type="checkbox" ${checks[it.key] ? "checked" : ""} />
      <div>
        <div class="t">${escapeHtml(it.title)}</div>
        <div class="s">${escapeHtml(it.sub)}</div>
      </div>
    `;
    row.querySelector("input").addEventListener("change", (e) => setCheck(it.key, e.target.checked));
    container.appendChild(row);
  });
}

function renderReset(){
  renderResetSection(resetMorningEl, RESET_MORNING);
  renderResetSection(resetSuppsEl, RESET_SUPPS);
  renderResetSection(resetRulesEl, RESET_RULES);
}

/*************************
 * Measurements (weekly)
 *************************/
const measSaveBtn = document.getElementById("measSaveBtn");
const measClearBtn = document.getElementById("measClearBtn");
const measHistory = document.getElementById("measHistory");

function weekKey(d=new Date()){
  // Monday-based week key
  const tmp = new Date(d);
  const day = tmp.getDay(); // 0 Sun..6 Sat
  const diff = (day === 0 ? -6 : 1) - day; // move to Monday
  tmp.setDate(tmp.getDate() + diff);
  return isoDate(tmp);
}

function getMeas(){ return load(LS.measurements, {}); }
function setMeas(all){ save(LS.measurements, all); }

function renderMeasurements(){
  const all = getMeas();
  const wk = weekKey();

  // load current week into inputs if exists
  const cur = all[wk] || {};
  const ids = ["weight","waist","hips","chest","thigh","arm"];
  ids.forEach(k=>{
    const el = document.getElementById("m_"+k);
    if(el) el.value = cur[k] || "";
  });

  // render history
  const keys = Object.keys(all).sort().reverse();
  if(keys.length === 0){
    measHistory.innerHTML = `<div class="hint" style="margin-top:10px;">No saved weeks yet.</div>`;
    return;
  }

  measHistory.innerHTML = keys.map(k=>{
    const r = all[k] || {};
    return `
      <div class="ex" style="padding:12px 14px;">
        <div class="exHead">
          <div>
            <p class="exName" style="font-size:16px;margin:0;">Week of ${escapeHtml(k)}</p>
            <div class="exMeta">
              Wt: ${escapeHtml(r.weight||"‚Äî")} ‚Ä¢ Waist: ${escapeHtml(r.waist||"‚Äî")} ‚Ä¢ Hips: ${escapeHtml(r.hips||"‚Äî")}
            </div>
          </div>
        </div>
      </div>
    `;
  }).join("");
}

measSaveBtn.addEventListener("click", ()=>{
  const wk = weekKey();
  const all = getMeas();
  all[wk] = {
    weight: document.getElementById("m_weight").value.trim(),
    waist: document.getElementById("m_waist").value.trim(),
    hips: document.getElementById("m_hips").value.trim(),
    chest: document.getElementById("m_chest").value.trim(),
    thigh: document.getElementById("m_thigh").value.trim(),
    arm: document.getElementById("m_arm").value.trim()
  };
  setMeas(all);
  renderMeasurements();
  alert("Saved this week!");
});

measClearBtn.addEventListener("click", ()=>{
  const wk = weekKey();
  const all = getMeas();
  if(!all[wk]) { alert("Nothing saved for this week yet."); return; }
  if(!confirm("Clear THIS week‚Äôs measurements?")) return;
  delete all[wk];
  setMeas(all);
  renderMeasurements();
});

/*************************
 * Edit Plan Modal
 *************************/
const editPlanBtn = document.getElementById("editPlanBtn");
const modalBack = document.getElementById("modalBack");
const editorBody = document.getElementById("editorBody");
const closeModalBtn = document.getElementById("closeModalBtn");
const cancelEditBtn = document.getElementById("cancelEditBtn");
const saveEditBtn = document.getElementById("saveEditBtn");
const addExerciseBtn = document.getElementById("addExerciseBtn");
const restoreDefaultsBtn = document.getElementById("restoreDefaultsBtn");

let draftPlan = null;

function openEditor(){
  draftPlan = structuredClone(getPlan());
  if(!draftPlan[selectedDay]) draftPlan[selectedDay] = [];
  renderEditorRows();
  modalBack.style.display = "flex";
  modalBack.setAttribute("aria-hidden","false");
}
function closeEditor(){
  modalBack.style.display = "none";
  modalBack.setAttribute("aria-hidden","true");
  draftPlan = null;
}

function renderEditorRows(){
  editorBody.innerHTML = "";
  const list = (draftPlan && draftPlan[selectedDay]) ? draftPlan[selectedDay] : [];

  if(list.length === 0){
    const empty = document.createElement("div");
    empty.className = "editRow";
    empty.innerHTML = `<div style="font-weight:900;">No exercises yet.</div><div style="color:var(--muted);font-weight:650;margin-top:4px;">Click ‚ÄúAdd exercise‚Äù to create one.</div>`;
    editorBody.appendChild(empty);
    return;
  }

  list.forEach((ex, idx)=>{
    const row = document.createElement("div");
    row.className = "editRow";
    row.innerHTML = `
      <div style="display:flex; justify-content:space-between; gap:10px; align-items:center; flex-wrap:wrap;">
        <div style="font-weight:950;">Exercise ${idx+1}</div>
        <button class="btn danger" type="button">Delete</button>
      </div>

      <div class="editGrid">
        <div>
          <label>Name</label>
          <input type="text" value="${escapeAttr(ex.name || "")}" />
        </div>
        <div>
          <label>Sets</label>
          <input type="number" min="1" step="1" value="${escapeAttr(ex.sets ?? 3)}" />
        </div>
        <div>
          <label>Reps</label>
          <input type="text" value="${escapeAttr(ex.reps || "")}" />
        </div>
      </div>
    `;

    const delBtn = row.querySelector("button");
    const [nameInput, setsInput, repsInput] = row.querySelectorAll("input");

    nameInput.addEventListener("input", e => draftPlan[selectedDay][idx].name = e.target.value);
    setsInput.addEventListener("input", e => {
      const v = parseInt(e.target.value, 10);
      draftPlan[selectedDay][idx].sets = Number.isFinite(v) && v > 0 ? v : 1;
    });
    repsInput.addEventListener("input", e => draftPlan[selectedDay][idx].reps = e.target.value);

    delBtn.addEventListener("click", ()=>{
      if(!confirm("Delete this exercise?")) return;
      draftPlan[selectedDay].splice(idx,1);
      renderEditorRows();
    });

    editorBody.appendChild(row);
  });
}

editPlanBtn.addEventListener("click", openEditor);
closeModalBtn.addEventListener("click", closeEditor);
cancelEditBtn.addEventListener("click", closeEditor);
modalBack.addEventListener("click", (e)=>{ if(e.target === modalBack) closeEditor(); });

addExerciseBtn.addEventListener("click", ()=>{
  if(!draftPlan[selectedDay]) draftPlan[selectedDay] = [];
  draftPlan[selectedDay].push({ name:"New Exercise", sets:3, reps:"10‚Äì12", description:"" });
  renderEditorRows();
});

restoreDefaultsBtn.addEventListener("click", ()=>{
  if(!confirm("Restore your original default plan for ALL days? (This does not erase your workout notes.)")) return;
  setPlan(structuredClone(DEFAULT_PLAN));
  closeEditor();
  renderWorkout(); renderProgress(); renderWeekSummary();
  alert("Defaults restored.");
});

saveEditBtn.addEventListener("click", ()=>{
  const list = draftPlan[selectedDay] || [];
  for(const ex of list){
    ex.name = String(ex.name || "").trim() || "Unnamed Exercise";
    ex.reps = String(ex.reps || "").trim() || "‚Äî";
    const s = parseInt(ex.sets, 10);
    ex.sets = Number.isFinite(s) && s > 0 ? s : 1;
  }
  setPlan(draftPlan);
  closeEditor();
  renderWorkout(); renderProgress(); renderWeekSummary();
  alert("Plan saved!");
});

/*************************
 * Info popup modal (circuits + mobility)
 *************************/
const infoBack = document.getElementById("infoBack");
const infoTitle = document.getElementById("infoTitle");
const infoSub = document.getElementById("infoSub");
const infoBody = document.getElementById("infoBody");
const infoCloseBtn = document.getElementById("infoCloseBtn");

function openInfo(title, html){
  infoTitle.textContent = title;
  infoSub.textContent = "Quick guide";
  infoBody.innerHTML = html;
  infoBack.style.display = "flex";
  infoBack.setAttribute("aria-hidden","false");
}
function closeInfo(){
  infoBack.style.display = "none";
  infoBack.setAttribute("aria-hidden","true");
}
infoCloseBtn.addEventListener("click", closeInfo);
infoBack.addEventListener("click", (e)=>{ if(e.target === infoBack) closeInfo(); });

const CORE_CIRCUIT_HTML = `
  <div class="muted">Pick 3‚Äì4 moves below. Do them in a loop.</div>
  <ul>
    <li>Rest 30‚Äì45 sec between moves</li>
    <li>Rest 60‚Äì90 sec between rounds</li>
    <li>Total time: 10‚Äì15 min</li>
  </ul>
  <h4>Option A (best overall)</h4>
  <ul>
    <li>Dead Bug ‚Äì 8‚Äì10/side</li>
    <li>Bird Dog ‚Äì 8‚Äì10/side</li>
    <li>Side Plank ‚Äì 20‚Äì30 sec/side</li>
    <li>Glute Bridge ‚Äì 12‚Äì15</li>
  </ul>
  <h4>Option B (more ‚Äútight waist‚Äù feel)</h4>
  <ul>
    <li>Pallof Press ‚Äì 10‚Äì12/side</li>
    <li>Plank ‚Äì 30‚Äì45 sec</li>
    <li>Suitcase Carry ‚Äì 30‚Äì45 sec/side</li>
    <li>Reverse Crunch ‚Äì 10‚Äì12 (slow)</li>
  </ul>
  <div class="muted">üëâ Rule: if anything hurts your low back, swap it.</div>
`;

const FULL_BODY_HTML = `
  <div class="muted">This is a moderate pace circuit, not HIIT.</div>
  <ul>
    <li>Pick 8 exercises (or use the ready-made list)</li>
    <li>Work 35‚Äì45 sec, rest 15‚Äì25 sec between exercises</li>
    <li>Rest 90 sec between rounds</li>
    <li>Total time: 20‚Äì30 min</li>
  </ul>
  <h4>Ready-made Full-Body Circuit</h4>
  <ul>
    <li>Goblet Squat</li>
    <li>Dumbbell Row</li>
    <li>Incline Dumbbell Press (or push-ups)</li>
    <li>Romanian Deadlift (light‚Äìmoderate)</li>
    <li>Shoulder Press</li>
    <li>Lateral Raise</li>
    <li>Glute Bridge / Hip Thrust</li>
    <li>Pallof Press or Dead Bug</li>
    <li class="muted">Optional 9‚Äì10: Biceps Curl, Triceps Rope Pushdown</li>
  </ul>
  <div class="muted">üëâ Goal: ‚Äúsweaty but controlled‚Äù with good form.</div>
`;

const MOBILITY_HTML = `
  <div class="muted">This is your ‚Äúfeel better tomorrow‚Äù block.</div>
  <h4>Quick 10‚Äì12 min mobility flow</h4>
  <ul>
    <li>Chest opener (doorway) ‚Äì 45 sec</li>
    <li>Child‚Äôs pose ‚Äì 45 sec</li>
    <li>Hip flexor stretch ‚Äì 45 sec/side</li>
    <li>Figure-4 glute ‚Äì 45 sec/side</li>
    <li>Hamstring stretch ‚Äì 45 sec/side</li>
    <li>Thoracic rotation (‚Äúopen books‚Äù) ‚Äì 8 reps/side</li>
    <li>Calf stretch ‚Äì 30‚Äì45 sec/side</li>
  </ul>
  <div class="muted">If knees are cranky: do more hip + upper body, less deep knee bending.</div>
`;

/*************************
 * Boot
 *************************/
document.getElementById("dateLine").textContent = prettyDate(today);

// Monday pulse (title)
if(new Date().getDay() === 1){
  document.getElementById("appTitle").classList.add("mondayPulse");
}

renderWorkout();
renderProgress();
renderWeekSummary();
renderReset();
renderMeasurements();
setTab("workout");
</script>


