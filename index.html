<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>My Daily Workout</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- PWA (keep your existing manifest/icons if you already have them) -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#2c7be5" />
  <link rel="apple-touch-icon" href="icon-192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">

  <style>
    :root{
      --bg:#f5f5f7;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --line:#e5e7eb;
      --brand:#2c7be5;
      --ok:#16a34a;
      --warn:#f59e0b;
      --danger:#dc2626;
      --shadow:0 10px 30px rgba(17,24,39,.08);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background:var(--bg);
      color:var(--text);
    }
    header{
      position:sticky; top:0; z-index:10;
      background:rgba(245,245,247,.85);
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--line);
    }
    .wrap{max-width:980px; margin:0 auto; padding:14px 14px;}
    .topbar{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .title{
      font-size:18px; font-weight:800; letter-spacing:.2px;
    }
    .subtitle{
      font-size:12px; color:var(--muted);
    }

    .tabs{
      display:flex; gap:8px; margin-top:10px; flex-wrap:wrap;
    }
    .tab{
      border:1px solid var(--line);
      background:var(--card);
      border-radius:999px;
      padding:10px 12px;
      font-weight:700;
      font-size:13px;
      cursor:pointer;
      user-select:none;
      box-shadow:0 2px 8px rgba(17,24,39,.04);
    }
    .tab.active{
      border-color: rgba(44,123,229,.35);
      background: rgba(44,123,229,.08);
      color: var(--brand);
    }

    main{padding:16px 14px 90px;}
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:14px;
      margin-bottom:12px;
    }
    .row{display:flex; gap:10px; flex-wrap:wrap;}
    .row > *{flex:1 1 200px;}
    .h{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-bottom:8px;
    }
    .h h2{
      margin:0;
      font-size:16px;
      font-weight:900;
    }
    .pill{
      font-size:12px;
      color:var(--muted);
      background:#f3f4f6;
      border:1px solid var(--line);
      padding:6px 10px;
      border-radius:999px;
      white-space:nowrap;
    }
    .btn{
      border:1px solid var(--line);
      background:var(--card);
      border-radius:12px;
      padding:10px 12px;
      font-weight:800;
      cursor:pointer;
    }
    .btn.primary{
      background:var(--brand);
      border-color:var(--brand);
      color:#fff;
    }
    .btn.ok{
      background:var(--ok);
      border-color:var(--ok);
      color:#fff;
    }
    .btn.danger{
      background:var(--danger);
      border-color:var(--danger);
      color:#fff;
    }
    .btn:disabled{
      opacity:.55;
      cursor:not-allowed;
    }
    .select{
      width:100%;
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px 12px;
      background:var(--card);
      font-weight:700;
    }
    .list{
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .item{
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .item .meta{min-width:0;}
    .item .name{
      font-weight:900;
      margin:0;
      font-size:14px;
    }
    .item .desc{
      margin:4px 0 0;
      color:var(--muted);
      font-size:12px;
      line-height:1.35;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:70ch;
    }
    .tiny{
      font-size:12px; color:var(--muted);
      margin:0;
    }

    .check{
      display:flex;
      align-items:center;
      gap:10px;
      padding:8px 10px;
      border:1px solid var(--line);
      border-radius:12px;
      background:#fff;
    }
    input[type="checkbox"]{
      width:18px; height:18px;
      accent-color: var(--brand);
      cursor:pointer;
    }

    /* Modal */
    .modal-backdrop{
      position:fixed; inset:0; background:rgba(0,0,0,.35);
      display:none; align-items:center; justify-content:center;
      padding:16px; z-index:50;
    }
    .modal{
      width:min(680px, 100%);
      background:var(--card);
      border:1px solid var(--line);
      border-radius:22px;
      box-shadow: 0 30px 80px rgba(0,0,0,.22);
      padding:14px;
    }
    .modal h3{margin:0 0 6px; font-size:16px; font-weight:950;}
    .modal p{margin:0; color:var(--muted); font-size:13px; line-height:1.45;}
    .modal .actions{display:flex; gap:10px; justify-content:flex-end; margin-top:12px; flex-wrap:wrap;}

    /* Calendar */
    .cal{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap:8px;
      margin-top:10px;
    }
    .cal .dow{
      font-size:11px; color:var(--muted); font-weight:800;
      text-align:center;
    }
    .day{
      border:1px solid var(--line);
      background:#fff;
      border-radius:14px;
      padding:10px;
      min-height:64px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .day .n{
      display:flex; align-items:center; justify-content:space-between;
      font-weight:900; font-size:12px;
    }
    .badge{
      font-size:10px; font-weight:900;
      padding:3px 8px; border-radius:999px;
      border:1px solid var(--line);
      background:#f3f4f6; color:var(--muted);
      width:fit-content;
    }
    .badge.done{background:rgba(22,163,74,.12); color:var(--ok); border-color:rgba(22,163,74,.25);}
    .badge.reset{background:rgba(44,123,229,.10); color:var(--brand); border-color:rgba(44,123,229,.25);}

    /* Confetti canvas */
    #confetti{
      position:fixed; inset:0; pointer-events:none; z-index:60;
      display:none;
    }
  </style>
</head>
<body>

<canvas id="confetti"></canvas>

<header>
  <div class="wrap">
    <div class="topbar">
      <div>
        <div class="title">My Daily Workout</div>
        <div class="subtitle" id="todayLine"></div>
      </div>
      <div class="pill" id="statusPill">Ready</div>
    </div>

    <div class="tabs">
      <div class="tab active" data-tab="workout">Workout</div>
      <div class="tab" data-tab="reset">Health Reset</div>
      <div class="tab" data-tab="calendar">Calendar</div>
      <div class="tab" data-tab="manage">Manage</div>
    </div>
  </div>
</header>

<main class="wrap">

  <!-- WORKOUT TAB -->
  <section id="tab-workout">
    <div class="card">
      <div class="h">
        <h2>Today’s Plan</h2>
        <span class="pill" id="weekdayPill"></span>
      </div>

      <div class="row">
        <div>
          <label class="tiny" for="daySelect">View a different day</label>
          <select id="daySelect" class="select"></select>
        </div>
        <div style="display:flex; align-items:flex-end; gap:10px;">
          <button class="btn ok" id="completeBtn">Complete Day</button>
          <button class="btn" id="viewNotesBtn">Workout Details</button>
        </div>
      </div>

      <p class="tiny" style="margin-top:10px;">Tip: Tap a workout to see the full description.</p>
    </div>

    <div class="card">
      <div class="h">
        <h2>Workouts</h2>
        <span class="pill" id="workoutCountPill"></span>
      </div>
      <div class="list" id="workoutList"></div>
    </div>
  </section>

  <!-- HEALTH RESET TAB -->
  <section id="tab-reset" style="display:none;">
    <div class="card">
      <div class="h">
        <h2>Morning Thyroid Routine</h2>
        <span class="pill">Daily</span>
      </div>

      <div class="list" id="morningChecklist"></div>

      <p class="tiny" style="margin-top:10px;">
        Your routine is okay: Synthroid at 6:30 AM → lemon water → coffee + collagen → then finish Baja Gold salt water.
        Keep minerals/fiber 3–4 hours away from Synthroid.
      </p>
    </div>

    <div class="card">
      <div class="h">
        <h2>Supplements Schedule</h2>
        <span class="pill">Simplified</span>
      </div>

      <div class="list" id="suppSchedule"></div>
    </div>

    <div class="card">
      <div class="h">
        <h2>2-Week Thyroid-Friendly Reset</h2>
        <span class="pill">No tracking</span>
      </div>

      <div class="list" id="resetChecklist"></div>

      <div style="margin-top:10px;">
        <p class="tiny"><strong>Daily rules:</strong> Protein first • Carbs once/day • Walk 10–15 min after carb meals • No punishment workouts.</p>
      </div>
    </div>
  </section>

  <!-- CALENDAR TAB -->
  <section id="tab-calendar" style="display:none;">
    <div class="card">
      <div class="h">
        <h2>Completion Calendar</h2>
        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <button class="btn" id="prevMonthBtn">◀</button>
          <button class="btn" id="nextMonthBtn">▶</button>
        </div>
      </div>
      <div class="row">
        <div class="pill" id="monthPill"></div>
        <div class="pill">✅ Completed days show green</div>
      </div>

      <div class="cal" id="calendarGrid"></div>
    </div>
  </section>

  <!-- MANAGE TAB -->
  <section id="tab-manage" style="display:none;">
    <div class="card">
      <div class="h">
        <h2>Workout Library</h2>
        <span class="pill">Edit anytime</span>
      </div>

      <div class="row">
        <div>
          <label class="tiny" for="wkName">Workout name</label>
          <input id="wkName" class="select" placeholder="e.g., Upper Body Strength" />
        </div>
        <div>
          <label class="tiny" for="wkDesc">Description (what it is)</label>
          <input id="wkDesc" class="select" placeholder="e.g., 3 sets: push-ups, rows, shoulder press..." />
        </div>
      </div>
      <div style="display:flex; gap:10px; margin-top:10px; flex-wrap:wrap;">
        <button class="btn primary" id="addWorkoutBtn">Add Workout</button>
        <button class="btn" id="resetDefaultsBtn">Restore Default Workouts</button>
      </div>

      <hr style="border:none;border-top:1px solid var(--line); margin:14px 0;">

      <div class="h">
        <h2>Weekly Plan Builder</h2>
        <span class="pill">Pick from your list</span>
      </div>

      <p class="tiny" style="margin:0 0 10px;">Choose workouts for each day. This controls what shows in the Workout tab.</p>

      <div class="list" id="planBuilder"></div>

      <div style="display:flex; gap:10px; margin-top:10px; flex-wrap:wrap;">
        <button class="btn primary" id="savePlanBtn">Save Weekly Plan</button>
        <button class="btn danger" id="clearPlanBtn">Clear Plan</button>
      </div>

      <hr style="border:none;border-top:1px solid var(--line); margin:14px 0;">

      <div class="h">
        <h2>Library Items</h2>
        <span class="pill" id="libCountPill"></span>
      </div>
      <div class="list" id="libraryList"></div>
    </div>
  </section>

</main>

<!-- Modal -->
<div class="modal-backdrop" id="modalBackdrop">
  <div class="modal">
    <h3 id="modalTitle"></h3>
    <p id="modalBody"></p>
    <div class="actions">
      <button class="btn" id="modalCloseBtn">Close</button>
    </div>
  </div>
</div>

<script>
  /***********************
   * Utilities & Storage
   ***********************/
  const LS_KEYS = {
    WORKOUTS: "mdw_workouts_v1",
    PLAN: "mdw_plan_v1",
    COMPLETIONS: "mdw_completions_v1", // { "YYYY-MM-DD": true }
    RESET_CHECKS: "mdw_reset_checks_v1", // { "YYYY-MM-DD": {key: true/false} }
  };

  const DAYS = ["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"];
  const DOW = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];

  function pad(n){ return String(n).padStart(2,"0"); }
  function toISODate(d){
    const y = d.getFullYear();
    const m = pad(d.getMonth()+1);
    const day = pad(d.getDate());
    return `${y}-${m}-${day}`;
  }
  function prettyDate(d){
    return d.toLocaleDateString(undefined, { weekday:"long", year:"numeric", month:"long", day:"numeric" });
  }
  function getWeekdayName(d){
    return d.toLocaleDateString(undefined, { weekday:"long" });
  }
  function safeJSONParse(val, fallback){
    try { return JSON.parse(val) ?? fallback; } catch { return fallback; }
  }
  function load(key, fallback){
    return safeJSONParse(localStorage.getItem(key), fallback);
  }
  function save(key, val){
    localStorage.setItem(key, JSON.stringify(val));
  }
  function uid(){
    return "w_" + Math.random().toString(16).slice(2) + Date.now().toString(16);
  }

  /***********************
   * Default Data
   ***********************/
  function defaultWorkouts(){
    return [
      { id: uid(), name: "Upper Body Strength", desc: "Push + pull focus. Examples: presses, rows, curls, triceps. Keep form clean; stop 1–2 reps before failure." },
      { id: uid(), name: "Lower Body Strength", desc: "Glutes/legs. Examples: squats (or goblet), hinges, step-ups, leg curls. Knee-friendly range." },
      { id: uid(), name: "Core + Mobility", desc: "Low-back friendly core + mobility. Examples: dead bug, bird dog, side plank, Pallof press, hip openers." },
      { id: uid(), name: "Full Body Circuit", desc: "Moderate pace circuit. 30–45 seconds each: squat pattern, push, pull, hinge, carry, core." },
      { id: uid(), name: "Incline Walk", desc: "15–30 minutes incline walk. Easy-to-moderate pace; breathe through nose if possible." }
    ];
  }

  function defaultPlan(workouts){
    // Try to assign by names (best effort)
    const find = (name) => (workouts.find(w => w.name === name)?.id) ?? workouts[0]?.id;
    return {
      Monday:    [find("Upper Body Strength"), find("Core + Mobility")],
      Tuesday:   [find("Lower Body Strength")],
      Wednesday: [find("Incline Walk"), find("Core + Mobility")],
      Thursday:  [find("Upper Body Strength")],
      Friday:    [find("Full Body Circuit"), find("Incline Walk")],
      Saturday:  [find("Incline Walk")],
      Sunday:    []
    };
  }

  function ensureData(){
    let workouts = load(LS_KEYS.WORKOUTS, null);
    if(!Array.isArray(workouts) || workouts.length === 0){
      workouts = defaultWorkouts();
      save(LS_KEYS.WORKOUTS, workouts);
    }

    let plan = load(LS_KEYS.PLAN, null);
    if(!plan || typeof plan !== "object"){
      plan = defaultPlan(workouts);
      save(LS_KEYS.PLAN, plan);
    }
  }

  /***********************
   * Modal
   ***********************/
  const modalBackdrop = document.getElementById("modalBackdrop");
  const modalTitle = document.getElementById("modalTitle");
  const modalBody = document.getElementById("modalBody");
  document.getElementById("modalCloseBtn").addEventListener("click", closeModal);
  modalBackdrop.addEventListener("click", (e) => {
    if(e.target === modalBackdrop) closeModal();
  });
  function openModal(title, body){
    modalTitle.textContent = title;
    modalBody.textContent = body;
    modalBackdrop.style.display = "flex";
  }
  function closeModal(){
    modalBackdrop.style.display = "none";
  }

  /***********************
   * Tabs
   ***********************/
  const tabs = Array.from(document.querySelectorAll(".tab"));
  const sections = {
    workout: document.getElementById("tab-workout"),
    reset: document.getElementById("tab-reset"),
    calendar: document.getElementById("tab-calendar"),
    manage: document.getElementById("tab-manage")
  };

  tabs.forEach(t => t.addEventListener("click", () => setTab(t.dataset.tab)));
  function setTab(tabName){
    tabs.forEach(t => t.classList.toggle("active", t.dataset.tab === tabName));
    Object.keys(sections).forEach(k => sections[k].style.display = (k === tabName) ? "" : "none");
    if(tabName === "calendar") renderCalendar();
    if(tabName === "manage") renderManage();
  }

  /***********************
   * Confetti
   ***********************/
  const confettiCanvas = document.getElementById("confetti");
  const ctx = confettiCanvas.getContext("2d");
  let confettiParticles = [];
  let confettiRAF = null;

  function startConfetti(){
    confettiCanvas.width = window.innerWidth;
    confettiCanvas.height = window.innerHeight;
    confettiCanvas.style.display = "block";

    confettiParticles = Array.from({length: 160}).map(() => ({
      x: Math.random() * confettiCanvas.width,
      y: -20 - Math.random() * confettiCanvas.height,
      vx: (Math.random() - 0.5) * 2,
      vy: 2 + Math.random() * 5,
      size: 4 + Math.random() * 6,
      rot: Math.random() * Math.PI,
      vr: (Math.random() - 0.5) * 0.2,
      life: 220 + Math.random()*120
    }));

    let tick = 0;
    function animate(){
      tick++;
      ctx.clearRect(0,0,confettiCanvas.width, confettiCanvas.height);

      for(const p of confettiParticles){
        p.x += p.vx;
        p.y += p.vy;
        p.rot += p.vr;
        p.life -= 1;

        ctx.save();
        ctx.translate(p.x, p.y);
        ctx.rotate(p.rot);
        ctx.fillRect(-p.size/2, -p.size/2, p.size, p.size);
        ctx.restore();
      }

      confettiParticles = confettiParticles.filter(p => p.life > 0 && p.y < confettiCanvas.height + 40);
      if(confettiParticles.length === 0 || tick > 260){
        stopConfetti();
        return;
      }
      confettiRAF = requestAnimationFrame(animate);
    }
    animate();
  }

  function stopConfetti(){
    if(confettiRAF) cancelAnimationFrame(confettiRAF);
    confettiRAF = null;
    confettiCanvas.style.display = "none";
    ctx.clearRect(0,0,confettiCanvas.width, confettiCanvas.height);
  }

  window.addEventListener("resize", () => {
    if(confettiCanvas.style.display === "block"){
      confettiCanvas.width = window.innerWidth;
      confettiCanvas.height = window.innerHeight;
    }
  });

  /***********************
   * Workout Tab
   ***********************/
  const today = new Date();
  const todayISO = toISODate(today);
  const todayWeekday = getWeekdayName(today);

  const todayLine = document.getElementById("todayLine");
  const weekdayPill = document.getElementById("weekdayPill");
  const statusPill = document.getElementById("statusPill");
  const daySelect = document.getElementById("daySelect");
  const workoutList = document.getElementById("workoutList");
  const workoutCountPill = document.getElementById("workoutCountPill");
  const completeBtn = document.getElementById("completeBtn");
  const viewNotesBtn = document.getElementById("viewNotesBtn");

  function initDaySelect(){
    daySelect.innerHTML = "";
    DAYS.forEach(d => {
      const opt = document.createElement("option");
      opt.value = d;
      opt.textContent = d;
      if(d === todayWeekday) opt.selected = true;
      daySelect.appendChild(opt);
    });
    daySelect.addEventListener("change", renderWorkoutTab);
  }

  function completions(){
    return load(LS_KEYS.COMPLETIONS, {});
  }
  function setCompleted(dateISO, val){
    const c = completions();
    if(val) c[dateISO] = true;
    else delete c[dateISO];
    save(LS_KEYS.COMPLETIONS, c);
  }
  function isCompleted(dateISO){
    return !!completions()[dateISO];
  }

  function renderWorkoutTab(){
    const selectedDay = daySelect.value || todayWeekday;
    weekdayPill.textContent = `${selectedDay} • ${prettyDate(today)}`;

    const workouts = load(LS_KEYS.WORKOUTS, []);
    const plan = load(LS_KEYS.PLAN, {});
    const ids = Array.isArray(plan[selectedDay]) ? plan[selectedDay] : [];

    const todaysWorkouts = ids
      .map(id => workouts.find(w => w.id === id))
      .filter(Boolean);

    workoutList.innerHTML = "";

    if(todaysWorkouts.length === 0){
      const empty = document.createElement("div");
      empty.className = "item";
      empty.innerHTML = `
        <div class="meta">
          <p class="name">No workouts assigned</p>
          <p class="desc">Go to Manage → Weekly Plan Builder to select workouts for this day.</p>
        </div>
        <button class="btn" onclick="setTab('manage')">Manage</button>
      `;
      workoutList.appendChild(empty);
    } else {
      todaysWorkouts.forEach(w => {
        const el = document.createElement("div");
        el.className = "item";
        el.innerHTML = `
          <div class="meta">
            <p class="name">${escapeHtml(w.name)}</p>
            <p class="desc">${escapeHtml(w.desc)}</p>
          </div>
          <button class="btn">View</button>
        `;
        el.querySelector("button").addEventListener("click", () => openModal(w.name, w.desc));
        el.addEventListener("click", (e) => {
          if(e.target.tagName.toLowerCase() !== "button") openModal(w.name, w.desc);
        });
        workoutList.appendChild(el);
      });
    }

    workoutCountPill.textContent = `${todaysWorkouts.length} planned`;

    const done = isCompleted(todayISO);
    statusPill.textContent = done ? "✅ Completed Today" : "Ready";
    statusPill.style.borderColor = done ? "rgba(22,163,74,.25)" : "var(--line)";
    statusPill.style.background = done ? "rgba(22,163,74,.10)" : "#f3f4f6";
    statusPill.style.color = done ? "var(--ok)" : "var(--muted)";

    completeBtn.textContent = done ? "Completed ✔" : "Complete Day";
    completeBtn.disabled = done;

    viewNotesBtn.onclick = () => {
      const msg = [
        "Today’s plan is your selected weekday’s workouts.",
        "",
        "Fat-loss friendly reminders:",
        "• Protein first",
        "• Carbs once/day",
        "• Walk 10–15 minutes after carb meals",
        "",
        "Want to change the plan? Go to Manage."
      ].join("\n");
      openModal("Workout Details", msg);
    };
  }

  completeBtn.addEventListener("click", () => {
    setCompleted(todayISO, true);
    renderWorkoutTab();
    startConfetti();
  });

  /***********************
   * Health Reset Tab (daily reset by date)
   ***********************/
  const morningChecklistEl = document.getElementById("morningChecklist");
  const suppScheduleEl = document.getElementById("suppSchedule");
  const resetChecklistEl = document.getElementById("resetChecklist");

  const morningItems = [
    { key:"synthroid", text:"6:30 AM: Synthroid (empty stomach)" },
    { key:"wait", text:"Wait 45–60 minutes before coffee/collagen/supplements" },
    { key:"lemon", text:"~7:00 AM: Warm lemon water is OK" },
    { key:"coffee", text:"Coffee + collagen after your wait window" },
    { key:"salt", text:"Finish Baja Gold salt water AFTER coffee (trace minerals)" }
  ];

  // Your simplified schedule based on what you asked to keep/trim:
  const scheduleItems = [
    { key:"lunch_probiotic", text:"Lunch: Good Girl Probiotic" },
    { key:"lunch_omega", text:"Lunch: Omega-3" },
    { key:"am_nad", text:"Morning or Lunch (not late): NAD+ (if you’re keeping it)" },
    { key:"dinner_multi", text:"Dinner: MultiComplete (keeps minerals away from Synthroid)" },
    { key:"dinner_chromium", text:"Dinner: Chromium picolinate 200 mcg" },
    { key:"dinner_citrucel", text:"Dinner: Citrucel" },
    { key:"bed_mag", text:"Bedtime: Magnesium" },
    { key:"asneeded_hum", text:"As needed: HUM Flatter Me with FIRST bite of heavy/carb meals" },
    { key:"optional_creatine", text:"Optional: Creatine (2–3 g) or pause if bloating bothers you" }
  ];

  const resetItems = [
    { key:"protein", text:"Protein first at every meal" },
    { key:"carb_once", text:"Carbs once per day (choose your carb meal)" },
    { key:"portion", text:"If heavy-carb: cut portion in half, eat protein first" },
    { key:"walk", text:"Walk 10–15 minutes after carb meals" },
    { key:"water", text:"Hydration + electrolytes (salt water OK after Synthroid window)" },
    { key:"no_hiit", text:"No punishment HIIT (keep cortisol lower)" }
  ];

  function resetChecks(){
    return load(LS_KEYS.RESET_CHECKS, {});
  }
  function getChecksForDate(dateISO){
    const all = resetChecks();
    return all[dateISO] || {};
  }
  function setCheck(dateISO, key, val){
    const all = resetChecks();
    const day = all[dateISO] || {};
    day[key] = !!val;
    all[dateISO] = day;
    save(LS_KEYS.RESET_CHECKS, all);
  }

  function renderChecklist(container, items, prefix){
    container.innerHTML = "";
    const checks = getChecksForDate(todayISO);

    items.forEach(it => {
      const row = document.createElement("div");
      row.className = "check";
      const id = `${prefix}_${it.key}`;
      row.innerHTML = `
        <input type="checkbox" id="${id}" ${checks[it.key] ? "checked" : ""} />
        <label for="${id}" style="cursor:pointer; font-weight:800; font-size:13px;">${escapeHtml(it.text)}</label>
      `;
      row.querySelector("input").addEventListener("change", (e) => setCheck(todayISO, it.key, e.target.checked));
      container.appendChild(row);
    });
  }

  function renderResetTab(){
    renderChecklist(morningChecklistEl, morningItems, "m");
    renderChecklist(suppScheduleEl, scheduleItems, "s");
    renderChecklist(resetChecklistEl, resetItems, "r");
  }

  /***********************
   * Calendar Tab
   ***********************/
  let calCursor = new Date(today.getFullYear(), today.getMonth(), 1);
  const monthPill = document.getElementById("monthPill");
  const calendarGrid = document.getElementById("calendarGrid");

  document.getElementById("prevMonthBtn").addEventListener("click", () => {
    calCursor = new Date(calCursor.getFullYear(), calCursor.getMonth()-1, 1);
    renderCalendar();
  });
  document.getElementById("nextMonthBtn").addEventListener("click", () => {
    calCursor = new Date(calCursor.getFullYear(), calCursor.getMonth()+1, 1);
    renderCalendar();
  });

  function renderCalendar(){
    const year = calCursor.getFullYear();
    const month = calCursor.getMonth();
    const first = new Date(year, month, 1);
    const last = new Date(year, month+1, 0);
    monthPill.textContent = first.toLocaleDateString(undefined, { month:"long", year:"numeric" });

    const startDow = first.getDay(); // 0=Sun
    const daysInMonth = last.getDate();

    calendarGrid.innerHTML = "";
    // DOW header
    DOW.forEach(d => {
      const el = document.createElement("div");
      el.className = "dow";
      el.textContent = d;
      calendarGrid.appendChild(el);
    });

    // blanks
    for(let i=0; i<startDow; i++){
      const blank = document.createElement("div");
      blank.style.visibility = "hidden";
      calendarGrid.appendChild(blank);
    }

    const comp = completions();

    for(let day=1; day<=daysInMonth; day++){
      const d = new Date(year, month, day);
      const iso = toISODate(d);
      const done = !!comp[iso];

      const cell = document.createElement("div");
      cell.className = "day";
      cell.innerHTML = `
        <div class="n">
          <span>${day}</span>
          <span class="badge ${done ? "done" : "reset"}">${done ? "Done" : "—"}</span>
        </div>
        <div class="tiny">${getWeekdayName(d)}</div>
      `;
      calendarGrid.appendChild(cell);
    }
  }

  /***********************
   * Manage Tab
   ***********************/
  const wkName = document.getElementById("wkName");
  const wkDesc = document.getElementById("wkDesc");
  const addWorkoutBtn = document.getElementById("addWorkoutBtn");
  const resetDefaultsBtn = document.getElementById("resetDefaultsBtn");
  const planBuilder = document.getElementById("planBuilder");
  const savePlanBtn = document.getElementById("savePlanBtn");
  const clearPlanBtn = document.getElementById("clearPlanBtn");
  const libraryList = document.getElementById("libraryList");
  const libCountPill = document.getElementById("libCountPill");

  addWorkoutBtn.addEventListener("click", () => {
    const name = (wkName.value || "").trim();
    const desc = (wkDesc.value || "").trim();
    if(!name){
      openModal("Missing name", "Add a workout name first.");
      return;
    }
    const workouts = load(LS_KEYS.WORKOUTS, []);
    workouts.push({ id: uid(), name, desc: desc || "Tap to add a description in Manage." });
    save(LS_KEYS.WORKOUTS, workouts);
    wkName.value = "";
    wkDesc.value = "";
    renderManage();
    renderWorkoutTab();
  });

  resetDefaultsBtn.addEventListener("click", () => {
    const workouts = defaultWorkouts();
    save(LS_KEYS.WORKOUTS, workouts);
    save(LS_KEYS.PLAN, defaultPlan(workouts));
    renderManage();
    renderWorkoutTab();
  });

  savePlanBtn.addEventListener("click", () => {
    const workouts = load(LS_KEYS.WORKOUTS, []);
    const selected = {};
    DAYS.forEach(day => {
      const sel = document.getElementById(`plan_${day}`);
      const ids = Array.from(sel.selectedOptions).map(o => o.value);
      // filter to existing
      selected[day] = ids.filter(id => workouts.some(w => w.id === id));
    });
    save(LS_KEYS.PLAN, selected);
    openModal("Saved", "Your weekly plan is updated.");
    renderWorkoutTab();
  });

  clearPlanBtn.addEventListener("click", () => {
    const empty = {};
    DAYS.forEach(d => empty[d] = []);
    save(LS_KEYS.PLAN, empty);
    renderManage();
    renderWorkoutTab();
  });

  function renderManage(){
    const workouts = load(LS_KEYS.WORKOUTS, []);
    const plan = load(LS_KEYS.PLAN, {});
    libCountPill.textContent = `${workouts.length} workouts`;

    // Plan builder (multi-select per day)
    planBuilder.innerHTML = "";
    DAYS.forEach(day => {
      const wrap = document.createElement("div");
      wrap.className = "item";
      wrap.innerHTML = `
        <div class="meta" style="width:100%;">
          <p class="name">${day}</p>
          <p class="tiny">Hold to select multiple (mobile: long-press and tap).</p>
          <select id="plan_${day}" class="select" multiple size="5"></select>
        </div>
      `;
      const sel = wrap.querySelector("select");
      workouts.forEach(w => {
        const opt = document.createElement("option");
        opt.value = w.id;
        opt.textContent = w.name;
        if(Array.isArray(plan[day]) && plan[day].includes(w.id)) opt.selected = true;
        sel.appendChild(opt);
      });
      planBuilder.appendChild(wrap);
    });

    // Library list with edit/delete
    libraryList.innerHTML = "";
    workouts.forEach(w => {
      const row = document.createElement("div");
      row.className = "item";
      row.innerHTML = `
        <div class="meta">
          <p class="name">${escapeHtml(w.name)}</p>
          <p class="desc">${escapeHtml(w.desc || "")}</p>
        </div>
        <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
          <button class="btn">Edit</button>
          <button class="btn danger">Delete</button>
        </div>
      `;

      const [editBtn, delBtn] = row.querySelectorAll("button");

      editBtn.addEventListener("click", () => {
        const newName = prompt("Edit workout name:", w.name);
        if(newName === null) return;
        const name = newName.trim();
        if(!name) return;

        const newDesc = prompt("Edit workout description:", w.desc || "");
        if(newDesc === null) return;

        const list = load(LS_KEYS.WORKOUTS, []);
        const idx = list.findIndex(x => x.id === w.id);
        if(idx >= 0){
          list[idx].name = name;
          list[idx].desc = (newDesc || "").trim();
          save(LS_KEYS.WORKOUTS, list);
          renderManage();
          renderWorkoutTab();
        }
      });

      delBtn.addEventListener("click", () => {
        if(!confirm(`Delete "${w.name}"?`)) return;

        let list = load(LS_KEYS.WORKOUTS, []);
        list = list.filter(x => x.id !== w.id);
        save(LS_KEYS.WORKOUTS, list);

        // Remove from plan
        const p = load(LS_KEYS.PLAN, {});
        Object.keys(p).forEach(day => {
          p[day] = (p[day] || []).filter(id => id !== w.id);
        });
        save(LS_KEYS.PLAN, p);

        renderManage();
        renderWorkoutTab();
      });

      libraryList.appendChild(row);
    });

    document.getElementById("libCountPill").textContent = `${workouts.length} workouts`;
  }

  /***********************
   * Escape helper
   ***********************/
  function escapeHtml(str){
    return String(str)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  /***********************
   * Boot
   ***********************/
  ensureData();
  todayLine.textContent = prettyDate(today);
  initDaySelect();
  renderWorkoutTab();
  renderResetTab();
  renderCalendar();
  setTab("workout");
</script>

</body>
</html>
